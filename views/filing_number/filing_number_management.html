<script type="text/javascript" src="/assets/js/jquery.min.js"></script>
<script type="text/javascript" src="/assets/js/core.js"></script>
<!--script type="text/javascript" src="/assets/js/does_connection_exist.js"></script-->


<style>

div {
  height: 90%;
  width: 100%;
  text-align: center;
}

div p {
  padding-top: 10%;
  font-size: 30px;
}

</style>



<div>
  <p>Arranging <b>filing numbers</b>, please wait.</p>
  <img src="/assets/images/loading.gif" class="icons" />
</div>


<script>

var urlToSearch = new URL(document.URL);
var patient_id = urlToSearch.searchParams.get("patient_id");

function fetchFilingNumber() {

  var url = apiProtocol + "://" + apiURL + ":" + apiPort + "/api/v1";
  url += '/patients/' + patient_id + '/filing_number';
  
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 ) {
      if (this.status == 201) {
        var obj = JSON.parse(this.responseText);
        var new_identifier = obj.new_identifier.identifier;
        try {
          var old_identifier = obj.archived_identifier.identifier;
          var secondary_patient_id = obj.patient_id;
        }catch(i) {
          var old_identifier = 'none';
          var secondary_patient_id = 0;
        }
        var url = '/apps/ART/views/filing_number/filing_numbers.html';
        url += '?primary_patient_id=' + patient_id;
        url += '&secondary_patient_id=' + secondary_patient_id;
        url += '&new_identifier=' + new_identifier;
        url += '&old_identifier=' + old_identifier;
        document.location = url;
      }else{
        var url = '/apps/ART/views/filing_number/archive.html?primary_patient_id=' + patient_id;
        document.location = url;
      }
    }
  };
  xhttp.open("POST", url, true);
  xhttp.setRequestHeader('Authorization', sessionStorage.getItem("authorization"));
  xhttp.setRequestHeader('Content-type', "application/json");
  xhttp.send();

}


setTimeout(function(){ fetchFilingNumber() }, 3000);

</script>


