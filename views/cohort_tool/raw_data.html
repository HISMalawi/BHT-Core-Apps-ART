
<link rel="stylesheet" href="/public/touchscreentoolkit/lib/stylesheets/touch-fancy.css" type="text/css">

<script type="text/javascript" src="/assets/js/jquery.min.js"></script>

<link rel="stylesheet" href="/apps/ART/assets/css/datatable/jquery.dataTables.min.css" type="text/css">
<link rel="stylesheet" href="/apps/ART/assets/css/datatable/scroller.dataTables.min.css" type="text/css">

<script type="text/javascript" src="/assets/js/datatables/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/assets/js/datatables/dataTables.fixedHeader.min.js"></script>


<script type="text/javascript" src="/assets/js/moment.js"></script>
<script type="text/javascript" src="/assets/js/core.js"></script>

<script type="text/javascript" src="/assets/js/virtual.keyboard.js"></script>

<style>
#high-level-view {
  display: none;
  background-color: #F4F4F4;
  border: 2px solid #E0E0E0;
  border-radius: 15px;
  height: 92%;
  padding: 5px;
  position: absolute;
  top: 10px;
  width: 95%;
  left: 2%;
  z-index: 991;
}

#spinner {
  position: absolute;
  top: 15%;
  left: 40%;
}

#report-cover {
  position: absolute;
  background-color: black;
  width: 100%;
  height: 102%;
  left: 0%;
  top: 0%;
  z-index: 990;
  opacity: 0.65;
}

.title-table {
  display: table;
  width: 100%;
}

.title-row {
  display: table-row;
}

.title-cell {
  display: table-cell;
  height: 30px;
  vertical-align: top;
  border-style: solid;
  border-width: 0px 0px 1px 0px;
}

#title-cell-left {
  vertical-align: middle;
  width: 100px;
}

#title-cell-left img {
  height: 95px;
  width: 95px;
  margin: 5px;
}

#title-cell-right {
  margin-left: 5px;
}

#data-cell {
  display: table-cell;
  width: 100%;
}

#report {
  width: 100%;
}

th {
  text-align: left;
}

</style>

<div class="title-table">
  <div class='title-row'>
    <div class='title-cell' id='title-cell-left'>
      <img src="/assets/images/login-logos/Malawi-Coat_of_arms_of_arms.png" />
    </div>
    <div class='title-cell' id='title-cell-right'>
      <table style="width: 100%; text-align: left; margin-left: 10px;">
        <tr>
          <th>Title:</th><td colspan="2" id="report-title">Raw data - cohort report<td>
        </tr>
        <!--tr>
          <th>Period:</th>
          <td id="start-date"><td>
          <td id="end-date"><td>
        </tr-->
      </table>
    </div>
  </div>
</div>
  
<div class="title-table">
  <div class='title-row'>
    <div id='data-cell'>
      <table id="report" class="display" style="width:100%">
      </table>
    </div>
  </div>
</div>

<div>
  <table id="example" class="display" width="100%"></table>
</div>

<div id="buttons" class="buttonsDiv">
  <button class="button blue navButton" onmousedown="javascript:window.history.back();"><span>Finish</span></button>
</div>

<img src="/apps/OPD/assets/images/formloader.gif" id="spinner" />
<div id="report-cover"></div>

<script>


var data_table;
var dataSet = [];
function initializeTable() {
  data_table = $('#example').DataTable({
    fixedHeader: true,
    searching: true,
    paging: false,
    data: dataSet,
    scrollY: 430,
    Processing: true,
    ServerSide: true,
    scroller: {
      loadingIndicator: true
    },
    columns: [
      { title: "ARV#" },
      { title: "First name" },
      { title: "Last name" },
      { title: "Gender" },
      { title: "BOD" },
      { title: "ESD" },
      { title: "DE" },
      { title: "Reg." },
      { title: "Outcome" },
      { title: "" }
    ]
  });

  lookForTag();
}

var limit = 0;
var limit2 = 999999;

function getData() {

  var url = sessionStorage.apiProtocol + "://" + sessionStorage.apiURL + ":" + sessionStorage.apiPort + "/api/v1";
  url += '/cohort_report_raw_data';
  url += "?date=" + sessionStorage.sessionDate;
  url += "&limit=" + limit + "&limit2=" + limit2;
  url += '&program_id=' + sessionStorage.programID;

  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
      document.getElementById('spinner').style = 'display: none;';
      document.getElementById('report-cover').style = 'display: none;';
      var obj = JSON.parse(this.responseText);
      loadData(obj);
    }
  };
  xhttp.open("GET", url, true);
  xhttp.setRequestHeader('Authorization', sessionStorage.getItem("authorization"));
  xhttp.setRequestHeader('Content-type', "application/json");
  xhttp.send();
}

var high_level_stats = {};
function loadData(data) {
  var tbody = document.getElementById('table-body');
    
  for(var i = 0 ; i < data.length ; i++){
    var given_name = data[i].given_name;
    var family_name = data[i].family_name;
    var gender  = data[i].gender;
    var arv_num = data[i].arv_number;
    var date_enrolled = data[i].date_enrolled;
    var earliest_start_date = data[i].earliest_start_date;
    var birthdate = data[i].birthdate;
    var outcome = data[i].outcome;
    var patient_id  = data[i].patient_id;

    try {
      birthdate = moment(birthdate).format('DD/MMM/YYYY');
    }catch(e) { 
    }
    
    try {
      date_enrolled  = moment(date_enrolled).format('DD/MMM/YYYY');
    }catch(e) { 
    }
    
    try {
      earliest_start_date = moment(earliest_start_date).format('DD/MMM/YYYY');
    }catch(e) { 
    }
    var attribues = [arv_num, given_name, family_name, gender, birthdate, 
      earliest_start_date, date_enrolled, '', outcome, buildViewBtn(patient_id)];

    var data_table_data = [];

    for(var r = 0 ; r < attribues.length; r++) {
      data_table_data.push(attribues[r]);
    }
    dataSet.push(data_table_data);
  }

  initializeTable();
}

function buildViewBtn(patient_id) {
  var sp = document.createElement('span');
  var btn = document.createElement('button');
  btn.setAttribute('class','view-btns');
  btn.innerHTML = '<span>view</span>';
  btn.setAttribute('onmousedown', 'mastercardView(' + patient_id +');');
  sp.appendChild(btn);
  return sp.innerHTML;
}

function mastercardView(patient_id) {
  location = '/views/patient/mastercard.html?patient_id=' + patient_id;
}
getData();
</script>

