

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
        <title>Encounters New</title>
        <script type="text/javascript" src="/public/touchscreentoolkit/lib/javascripts/touchScreenToolkit.js" defer="true"></script>
        <script type="text/javascript" src="/assets/js/jquery.min.js"></script>

        <script type="text/javascript" src="/assets/js/yes_no_ctrls.js"></script>
        <link rel="stylesheet" href="/assets/css/yes_no_ctrls.css" type="text/css"/>
        <script type="text/javascript" src="/assets/js/post_parameters.js"></script>
        <script type="text/javascript" src="/assets/js/generic_ajaxrequest.js"></script>
        <script type="text/javascript" src="/assets/js/moment.js"></script>
        <script type="text/javascript" src="/assets/js/alertifyjs/alertify.js"></script>
        <script type="text/javascript" src="/assets/js/does_connection_exist.js"></script>

        <link rel="stylesheet" href="/assets/css/alertifyjs/css/alertify.css" type="text/css">
        <script type="text/javascript" src="/assets/js/demographics.js"></script>

        <script type="text/javascript">
            tstUsername = "admin";
            var tstCurrentDate = moment(tstCurrentDate).format("YYYY-MM-DD");

        </script>
        <style type="text/css">
            #tab {
                height:312px;
            }
            #barcode {
                background:transparent none repeat scroll 0 0;
                border-color:-moz-use-text-color -moz-use-text-color silver;
                border-style:none none solid;
                border-width:medium medium 1px;
                font-family:"Nimbus Sans L","Arial Narrow",sans-serif;
                font-size:2.2em;
                padding-left:5px;
                width:400px;
            }

            #header div {
                font-weight:normal;
                float:none;
                clear:both;
            }

            .summary{
                position:relative;
                float:center;
                width:100%;
                padding-left:10px;
                padding-right:10px;
            }

            .summary td , th{
                border-style:solid;
                border-width:thin;
                padding:5px;
            }

            .summary tbody{
                position:relative;
                height:500px;
                overflow:auto;
                overflow-x: hidden;
            }

            .summary>tbody tr {
                position:relative;
                height:12px;
            }
            .summary>thead tr {
                position:relative;
                height:12px;
            }

            .tt_controls_date_of_confirmatory_hiv_test #num { display:none; }

            .tt_controls_date_last_taken #num { display:none; }

            .tt_controls_date_of_confirmatory_hiv_test table {  position: absolute; top: -360px; }

            .tt_controls_date_art_last_taken table {  position: absolute; top: -360px; }

            .tt_controls_last_arv_drugs_taken .keyboard { display:none; }

            .tt_controls_cd4_count #qwerty , .tt_controls_cd4_percent #qwerty {
                display: none;
            }

            .tt_controls_cd4_count #equals, .tt_controls_cd4_percent #equals {
                display: inline;
            }

            .tt_controls_cd4_count #lessthan, .tt_controls_cd4_count #greaterthan {
                position: absolute;
                right: 65%;
            }

            .tt_controls_cd4_percent #lessthan, .tt_controls_cd4_percent #greaterthan {
                position: absolute;
                right: 65%;
            }

            .tt_controls_cd4_count #greaterthan , .tt_controls_cd4_percent #greaterthan{
                position: absolute;
                right: 65%;
                top: 5px;
            }

            .tt_controls_cd4_count #lessthan , .tt_controls_cd4_percent #lessthan {
                top: 145px;
            }

            .tt_controls_cd4_count #lessthan, .tt_controls_cd4_count #greaterthan { display:block; float:right }
            .tt_controls_cd4_percent #lessthan, .tt_controls_cd4_percent #greaterthan { display:block; float:right }

            .tt_controls_weight_kg #qwerty , .tt_controls_height_cm #qwerty {
                display: none;
            }

            .tt_controls_confirmatory_hiv_test_year #Unknown { display: inline; }

            .tt_controls_confirmatory_hiv_test_month .keyboard { display:none; }

            #tt_page_month_of_cd4_count .inputFrameClass {  height: 86%; }

            #tt_page_month_of_cd4_count #viewport {  height: 85%; }

            #tt_page_confirmatory_hiv_test_month .options {  height: 90%; }

            #tt_page_confirmatory_hiv_test_month .inputFrameClass {  height: 86%; }

            .tt_controls_month_started_art .keyboard { display:none; }

            #tt_page_month_started_art .options {  height: 90%; }

            #tt_page_month_started_art .inputFrameClass {  height: 86%; }

            .tt_controls_year_last_taken_arvs #Unknown { display: inline; }

            .tt_controls_month_art_last_taken .keyboard { display:none; }

            #tt_page_month_last_taken_arvs .options {  height: 90%; }

            #tt_page_month_art_last_taken .inputFrameClass {  height: 86%; }

            .tt_controls_year_started_art #Unknown { display: inline; }

            .tt_controls_month_of_cd4_count .keyboard{ display: none !important; }

            .NoKeyboard .options {
                height: 591px !important;
            }
        </style>
    </head>

    <body id="mateme">
        <div id="container">
            <div id="content">

                <script>
                    var patient_id = sessionStorage.patientID;
                    getDemographics(patient_id);
                    var tt_cancel_destination = "/views/patient_dashboard.html?patient_id=" + patient_id;
                    var todayDate = new Date(tstCurrentDate);
                    var originaltestDate = ""

                    var alert_date = new Date(todayDate);
                    alert_date.setDate(alert_date.getDate()- 90);

                    var alertDate = createDates(moment(alert_date).format("YYYY"), moment(alert_date).format("MM"), moment(alert_date).format("DD"));
                    // var patient_age = parseInt(sessionStorage.patientAge);


                    var currentYear = moment(tstCurrentDate).format("YYYY");
                    var currentMonth = moment(tstCurrentDate).format("MM");
                    var selected_stage_conditions = {};
                    var selected_stage_conditions_copy = {}

                    var firstPositiveHivTestType = "UNKNOWN";
                    function getFirstPositiveHivTestTypeObservation() {
                        var confirmatory_hiv_test_type_concept_id = 7880;
                        var url = apiProtocol + "://" + apiURL + ":" + apiPort + "/api/v1/observations?person_id=" + sessionStorage.patientID + "&concept_id=" + confirmatory_hiv_test_type_concept_id + "&page_size=1";
                        var xhttp = new XMLHttpRequest();
                        xhttp.onreadystatechange = function() {
                            if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
                                var latest_hiv_confirmatory_test_observation = JSON.parse(this.responseText)[0];
                                if (latest_hiv_confirmatory_test_observation){
                                    value_coded = parseInt(latest_hiv_confirmatory_test_observation.value_coded)
                                    firstPositiveHivTestType = hivTestTypeConceptIDMap(value_coded)
                                }
                            }
                        };

                        xhttp.open("GET", url, true);
                        xhttp.setRequestHeader('Authorization', sessionStorage.getItem("authorization"));
                        xhttp.setRequestHeader('Content-type', "application/json");
                        xhttp.send();
                    }
                    getFirstPositiveHivTestTypeObservation();

                    function hivTestTypeConceptIDMap(conceptID){
                        conceptMap = {
                            "": "",
                            "1040": "HIV rapid test",
                            "844": "HIV DNA polymerase chain reaction",
                            "1118": "Not done",
                            "1067": "Unknown"
                        }

                        return conceptMap[conceptID]
                    }

                    
                    var regimen_formulations = {"5": "TDF/3TC/EFV", "11": "AZT/3TC + LPV/r", "0": "ABC/3TC + NVP", "6": "TDF/3TC + NVP", "12": "DRV + r + ETV + RAL", "7": "TDF/3TC + ATV/r", "2": "AZT/3TC/NVP", "8": "AZT/3TC + ATV/r", "9": "ABC/3TC + LPV/r", "4": "AZT/3TC + EFV", "10": "TDF/3TC + LPV/r"};
                    var median_weight_height = [];
                    var sessionDate = new Date(tstCurrentDate);
                    var birthYear = parseInt(moment(sessionStorage.patientDOB).format("YYYY"));
                    var birthMonth = parseInt(moment(sessionStorage.patientDOB).format("MM"));
                    var birthDay = parseInt(moment(sessionStorage.patientDOB).format("DD"));

                    function checkTestDate(td) {
                        var testDate = createDates($('year_art_last_taken').value, $('month_art_last_taken').value, td.value);
                        var years = testDate.getFullYear();
                        var month = testDate.getMonth() + 1;
                        years = currentYear - years;
                        month = currentMonth - month;
                        var total = (years * 12) + month;

                        if (originaltestDate == "") {
                            if ((total > ageInMonths) || (testDate > todayDate)) {
                                return false
                            }
                            else {
                                return true
                            }

                        }
                        else if ((total > ageInMonths) || (testDate <= originaltestDate) || (testDate > todayDate)) {
                            return false
                        }
                        else {
                            return true
                        }

                    }

                    function checkCd4Date() {
                        $('cd4_count_date').value = createDates($('year_of_cd4').value, $('month_of_cd4').value, $('day_of_cd4').value);
                    }

                    //checks if the patient needs to be referred to HTC basesd on the test date
                    function updateTestDate() {
                        var testDate = createDates($('year_art_last_taken').value, $('month_art_last_taken').value, $('day_art_last_taken').value);
                        $('date_art_last_taken').value = testDate;
                        if (testDate == 'Invalid Date') {
                            return true
                        }
                        else {
                            return isTestOverDue(testDate, alertDate);
                        }
                    }

                    function checkConfirmDate() {
                        var testDate = createDates($('confirmatory_hiv_test_year').value, $('confirmatory_hiv_test_month').value, $('confirmatory_hiv_test_day').value);
                        var years = testDate.getFullYear();
                        var month = testDate.getMonth() + 1;

                        years = currentYear - years;
                        month = currentMonth - month;
                        var total = (years * 12) + month;


                        if ($('date_started_art') != null) {
                            if ((testDate > $('date_started_art').value) || (total > ageInMonths) || (testDate <= originaltestDate) || (testDate > todayDate)) {
                                return false
                            }
                            else {
                                return true
                            }
                        }
                        else if ((total > ageInMonths) || (testDate <= originaltestDate) || (testDate > todayDate)) {
                            return false
                        }
                        else {
                            return true
                        }

                    }

                    //checks if the patient needs to be referred to HTC basesd on the test date
                    function updateConfirmDate() {

                        var testDate = createDates($('confirmatory_hiv_test_year').value, $('confirmatory_hiv_test_month').value, $('confirmatory_hiv_test_day').value);
                        $('confirmatory_hiv_test_date').value = testDate;
                        if (testDate == 'Invalid Date') {
                            return true
                        }
                        else {
                            return isTestOverDue(testDate, alertDate);
                        }
                    }

                    function checkStartDate() {
                        var testDate = createDates($('year_started_art').value, $('month_started_art').value, $('day_started_art').value);
                        var years = testDate.getFullYear();
                        var month = testDate.getMonth() + 1;

                        years = currentYear - years;
                        month = currentMonth - month;
                        var total = (years * 12) + month;

                        if ((total > ageInMonths) || (testDate <= originaltestDate) || (testDate > todayDate)) {
                            return false
                        }
                        else {
                            return true
                        }

                    }


                    //checks if the patient needs to be referred to HTC basesd on the test date

                    function calculateAge(birthdate, birthdate_estimated, date_created, today) {
                        patient_age = (today.getFullYear() - birthdate.getFullYear()) + ((today.getFullYear() - (birthdate.getMonth() + 1)) + ((today.getDate() - birthdate.getDate()) < 0 ? -1 : 0) < 0 ? -1 : 0)
                        birth_date = birthdate
                        estimate = birthdate_estimated
                        if (birth_date.month == 7 && birth_date.day == 1 && estimate == 1 && Time.now.month < birth_date.month && date_created.getFullYear() == (new Date().getFullYear())) {
                            return patient_age + 1
                        } else {
                            return patient_age
                        }
                    }

                    function updateStartDate() {
                        var testDate = createDates($('year_started_art').value, $('month_started_art').value, $('day_started_art').value);
                        $('date_started_art').value = testDate;
                        age = calculateAge(birthdate, patientBirthdateEstimated, dateCreated, testDate);
                        if (testDate == 'Invalid Date') {
                            return true
                        }
                        else {
                            return isTestOverDue(testDate, alertDate);
                        }
                    }

                    function updateInitiationDate() {

                        var testDate = createDates($('hiv_initiation_year').value, $('hiv_initiation_month').value, $('hiv_initiation_day').value);
                        $('hiv_initiation_date').value = testDate;
                        return isTestOverDue(testDate, alertDate);
                    }

                    function isTestOverDue(testDate, alertDate) {
                        if (testDate <= alertDate) {
                            return true;
                        } else {
                            return false;
                        }
                    }

                    function createDates(year, month, day) {
                        date_str = year

                        if (month.length == 1)
                            month = '0' + month

                        date_str += '-' + month

                        if (day.length == 1)
                            day = '0' + day

                        date_str += '-' + day

                        intyear = 0;
                        intmonth = 0;
                        intday = 0;
                        intyear = parseInt(date_str.substring(0, 4))
                        intmonth = (parseInt(date_str.substring(5, 7)) - 1)
                        intday = (parseInt(date_str.substring(8, 10)))

                        if (intmonth == -1)
                            intmonth = (parseInt(date_str.substring(5, 7).substring(1, 2)) - 1)

                        if (intday == 0)
                            intday = parseInt(date_str.substring(8, 10).substring(1, 2))

                        return new Date(intyear, intmonth, intday);
                    }


                    function validateDOB() {
                        setDOB();
                        curr_date = new Date();

                        if (dateCreate(set_dob) == 'Invalid Date') {
                            if (set_dob.split('-')[1] == 'Unknown')
                                return true

                            if (curr_date.getFullYear() == parseInt(dob_year)) {
                                if ((curr_date.getMonth() + 1) < parseInt(dob_month)) {
                                    if (document.getElementById('tt_page_month_started_art') != null)
                                        return true

                                    return false
                                }
                            }

                            if (dob_month == 'Unknown') {
                                if (curr_date.getFullYear() == parseInt(dob_year)) {
                                    if ((curr_date.getMonth() + 1) < parseInt(dob_month))
                                        return false
                                }
                            }
                        } else {
                            if (document.getElementById('tt_page_month_started_art') != null)
                                return true

                            if (curr_date < dateCreate(set_dob))
                                return false
                        }
                        return true
                    }

                    function checkBirthDate() {
                        var dateCheck = "";
                        var confirmatoryHIVtestDate = new Date($('confirmatory_hiv_test_date').value);
                        //var patientBirthDate = new Date("","","");
                        var patientBirthDate = new Date("")


                        if (patientBirthDate <= confirmatoryHIVtestDate) {
                            dateCheck = 'true'
                        } else {
                            dateCheck = 'false'
                        }
                        return dateCheck;
                    }

                    function showConditions() {
                        if ($("ever_registered_at_ART_clinic").value == "NO") {
                            return false;
                        } else if ($('has_transfer_letter').value == "YES") {
                            return true;
                        } else {
                            return false;
                        }
                    }

                    function updateCD4CountKeyPad() {
                        curr_page = tstCurrentPage - 1
                        buttons = document.getElementsByClassName("keyboardButton");
                        $("clearButton").setAttribute("onmousedown", "clearInput();updateCD4CountKeyPad();");
                        $("backButton").setAttribute("onmousedown", ";gotoPage(" + curr_page + ", null, true);resetPad();");
                        $("nextButton").setAttribute("onmousedown", "gotoNextPage();resetPad();");

                        for (i = 0; i < buttons.length; i++) {
                            if (buttons[i].id == "equals" || buttons[i].id == "greaterthan" || buttons[i].id == "lessthan") {
                                buttons[i].disabled = false;
                                if (buttons[i].id == "equals") {
                                    buttons[i].setAttribute("onmousedown", "press('=');resetKeyPad();");
                                } else if (buttons[i].id == "lessthan") {
                                    buttons[i].setAttribute("onmousedown", "press('<');resetKeyPad();");
                                } else if (buttons[i].id == "greaterthan") {
                                    buttons[i].setAttribute("onmousedown", "press('>');resetKeyPad();");
                                }
                            } else {
                                buttons[i].disabled = true;
                            }
                        }
                    }


                    function updateCD4CountOld() {
                        var cd4_available = $('new_cd4_count_available').value == 'YES';
                        var cd4_count = cd4_available ? $('cd4_count').value : null;

                        try {
                            cd4_count_numeric = parseInt(cd4_count);
                        } catch (e) {
                            cd4_count_numeric = null;
                        }

                        if (cd4_count_numeric == null || '' + cd4_count_numeric == 'NaN') {
                            try {
                                var matches = cd4_count.match(/^(>|<|=)([0-9\.]+)$/);
                                cd4_count_modifier = matches[1];
                                cd4_count_estimate = parseInt(matches[2]);
                                cd4_count_numeric = cd4_count_estimate;
                                if (cd4_count_modifier == '<')
                                    cd4_count_numeric -= 1;
                                if (cd4_count_modifier == '>')
                                    cd4_count_numeric += 1;
                            } catch (e) {
                                cd4_count_modifier = null;
                                cd4_count_estimate = null;
                                cd4_count_numeric = null;
                            }
                        }

                        if (cd4_count_numeric == null || '' + cd4_count_numeric == 'NaN') {
                            $('cd4_count_less_than_250').value = "UNKNOWN";
                            $('cd4_count_less_than_350').value = "UNKNOWN";
                        } else {
                            $('cd4_count_less_than_250').value = (cd4_count_numeric <= 250) ? "YES" : "NO";
                            $('cd4_count_less_than_350').value = (cd4_count_numeric <= 350) ? "YES" : "NO";
                        }
                    }

                    var cd4_count_modifier_global = "";

                    function updateCD4Count() {
                        var cd4_available = $('new_cd4_count_available').value == 'YES';
                        var cd4_count = cd4_available ? $('cd4_count').value : null;
                        var cd4_count_modifier = '';

                        try {
                            cd4_count_numeric = parseInt(cd4_count.match(/[0-9](.*)/i)[0]);
                        } catch (e) {
                            cd4_count_numeric = null;
                        }

                        if (cd4_count_numeric == null || '' + cd4_count_numeric == 'NaN') {
                            try {
                                var matches = cd4_count.match(/^(\<|\>)([0-9\.]+)$/)
                                cd4_count_modifier = matches[1];
                                cd4_count_estimate = parseInt(matches[2]);
                                cd4_count_numeric = cd4_count_estimate;
                                if (cd4_count_modifier == '<')
                                    cd4_count_numeric -= 1;
                                if (cd4_count_modifier == '>')
                                    cd4_count_numeric += 1;
                            } catch (e) {
                                cd4_count_modifier = null;
                                cd4_count_estimate = null;
                                cd4_count_numeric = null;
                            }
                        } else {
                            var matches = cd4_count.match(/^(=|\<|\>)([0-9\.]+)$/)
                            cd4_count_modifier = matches[1];
                        }

                        if (cd4_count_numeric == null || '' + cd4_count_numeric == 'NaN') {
                            $('cd4_count_less_than_250').value = "UNKNOWN";
                            $('cd4_count_less_than_350').value = "UNKNOWN";
                            $('cd4_count_less_than_500').value = "UNKNOWN";
                        } else {

                            if (cd4_count_numeric <= 250 && cd4_count_modifier != ">") {

                                $('cd4_count_less_than_250').value = "YES";
                                answers_hash["cd4_less_than_or_equal_to_250"] = "YES";
                            } else {
                                $('cd4_count_less_than_250').value = "NO";
                                answers_hash["cd4_less_than_or_equal_to_250"] = "NO";
                            }

                            if (cd4_count_numeric <= 350 && cd4_count_modifier != ">") {
                                $('cd4_count_less_than_350').value = "YES";
                                answers_hash["cd4_less_than_or_equal_to_350"] = "YES";
                            } else {
                                $('cd4_count_less_than_350').value = "NO";
                                answers_hash["cd4_less_than_or_equal_to_350"] = "YES";
                            }

                            if (cd4_count_numeric <= 500 && cd4_count_modifier != ">") {
                                $('cd4_count_less_than_500').value = "YES";
                                answers_hash["cd4_less_than_or_equal_to_500"] = "YES"
                            } else {
                                $('cd4_count_less_than_500').value = "NO";
                                answers_hash["cd4_less_than_or_equal_to_500"] = "NO"
                            }
                        }

                        cd4_count_modifier_global = cd4_count_modifier;
                        answers_hash["cd4_count"] = cd4_count_numeric;
                    }

                    var cd4_percent_modifier_global = "";
                    function updateCD4Percent() {
                        var cd4_percent_available = $('new_cd4_percent_available').value == 'YES';
                        var cd4_percent = cd4_percent_available ? $('cd4_percent').value : null;
                        var cd4_percent_numeric, cd4_percent_estimate, cd4_percent_modifier;

                        try {
                            cd4_percent_numeric = parseInt(cd4_percent);
                        } catch (e) {
                            cd4_percent_numeric = null;
                        }

                        if (cd4_percent_numeric == null || '' + cd4_percent_numeric == 'NaN') {
                            try {
                                var matches = cd4_percent.match(/^(>|<|=)([0-9\.]+)$/);
                                cd4_percent_modifier = matches[1];
                                cd4_percent_estimate = parseInt(matches[2]);
                                cd4_percent_numeric = cd4_percent_estimate;
                                if (cd4_percent_modifier == '<')
                                    cd4_percent_numeric -= 1;
                                if (cd4_percent_modifier == '>')
                                    cd4_percent_numeric += 1;
                            } catch (e) {
                                cd4_percent_modifier = null;
                                cd4_percent_estimate = null;
                                cd4_percent_numeric = null;
                            }
                        }

                        if (cd4_percent_numeric == null || '' + cd4_percent_numeric == 'NaN') {
                            $('cd4_percent_less_than_25').value = "UNKNOWN";

                            answers_hash["cd4_less_than_25"] = "UNKNOWN";
                        } else {
                            $('cd4_percent_less_than_25').value = (cd4_percent_numeric < 25) ? "YES" : "NO";
                            answers_hash["cd4_percent_less_than_25"] = $('cd4_percent_less_than_25').value;
                        }
                        cd4_percent_modifier_global = cd4_percent_modifier;
                        answers_hash["cd4_percent"] = cd4_percent_numeric;
                    }



                    function resetPad() {
                        curr_page = tstCurrentPage - 1
                        buttons = document.getElementsByClassName("keyboardButton");
                        for (i = 0; i < buttons.length; i++) {
                            buttons[i].disabled = false;
                        }
                        $("clearButton").setAttribute("onmousedown", "clearInput();");
                        $("backButton").setAttribute("onmousedown", ";gotoPage(" + curr_page + ", null, true);");
                        $("nextButton").setAttribute("onmousedown", "gotoNextPage();");
                    }

                    function resetKeyPad() {
                        buttons = document.getElementsByClassName("keyboardButton");
                        for (i = 0; i < buttons.length; i++) {
                            if (buttons[i].id == "equals" || buttons[i].id == "greaterthan" || buttons[i].id == "lessthan") {
                                buttons[i].disabled = true;
                            } else {
                                buttons[i].disabled = false;
                            }
                        }
                    }

                    function updateCD4CountKeyPad() {
                        curr_page = tstCurrentPage - 1
                        buttons = document.getElementsByClassName("keyboardButton");
                        $("clearButton").setAttribute("onmousedown", "clearInput();updateCD4CountKeyPad();");
                        $("backButton").setAttribute("onmousedown", ";gotoPage(" + curr_page + ", null, true);resetPad();");
                        $("nextButton").setAttribute("onmousedown", "gotoNextPage();resetPad();");

                        for (i = 0; i < buttons.length; i++) {
                            if (buttons[i].id == "equals" || buttons[i].id == "greaterthan" || buttons[i].id == "lessthan") {
                                buttons[i].disabled = false;
                                if (buttons[i].id == "equals") {
                                    buttons[i].setAttribute("onmousedown", "press('=');resetKeyPad();");
                                } else if (buttons[i].id == "lessthan") {
                                    buttons[i].setAttribute("onmousedown", "press('<');resetKeyPad();");
                                } else if (buttons[i].id == "greaterthan") {
                                    buttons[i].setAttribute("onmousedown", "press('>');resetKeyPad();");
                                }
                            } else {
                                buttons[i].disabled = true;
                            }
                        }
                    }

                    function getDateStartedART() {
                        var year = $("year_started_art").value;
                        var month = $("month_started_art").value;
                        var day = $("day_started_art").value;

                        if (month.length == 1)
                            month = 0 + month;

                        if (day.length == 1)
                            day = 0 + day;

                        if (year == "Unknown") {
                            return new Date();
                        } else if (month == "Unknown") {
                            return new Date(year + "-07-01")
                        } else if (day == "Unknown") {
                            return new Date(year + "-" + month + "-01")
                        } else {
                            return new Date(year + "-" + month + "-" + day)
                        }
                    }

                    function calculateWHOstage() {
                        stage = "I";
                        if ($("has_transfer_letter").value == "YES") {
                            if ($("stage_4_conditions").value.length > 0) {
                                stage = "IV";
                            } else if ($("stage_3_conditions").value.length > 0) {
                                stage = "III";
                            } else if ($("stage_2_conditions").value.length > 0) {
                                stage = "II";
                            }
                            var startDate = getDateStartedART();
                        }

                        if (showARTstartDate() && $("year_started_art").value.toUpperCase() == "UNKNOWN") {
                            ARTstartDateEstimate = $("art_start_date_estimation").value;

                            if (ARTstartDateEstimate == "6 months") {
                              startDate = new Date(sessionStorage.sessionDate);
                              startDate.setDate(todays_date.getDate() - (28 * 6) );
                            } else if (ARTstartDateEstimate == "12 months") {
                              startDate = new Date(sessionStorage.sessionDate)
                              startDate.setDate(todays_date.getDate() - (28 * 12) );
                            } else if (ARTstartDateEstimate == "18 months") {
                              startDate = new Date(sessionStorage.sessionDate)
                              startDate.setDate(todays_date.getDate() - (28 * 18) );
                            } else if (ARTstartDateEstimate == "24 months") {
                              startDate = new Date(sessionStorage.sessionDate)
                              startDate.setDate(todays_date.getDate() - (28 * 24) );
                            } else if (ARTstartDateEstimate == "Over 2 years") {
                              startDate = new Date(sessionStorage.sessionDate)
                              startDate.setDate(todays_date.getDate() - (28 * 30));
                            } else {
                              var startDate = getDateStartedART();
                            }
                        }

                        var birthdate = sessionStorage.birthdate;
                        var date_created = sessionStorage.date_created;
                        var patientBirthdate = new Date(birthdate);
                        var dateCreated = new Date(date_created);
                        var patientBirthdateEstimated = "0";

                        if (!startDate)
                            return

                        var patient_age = age(patientBirthdate, patientBirthdateEstimated, dateCreated, startDate);

                        if (patient_age <= 14) {
                            $("who_stage").value = "WHO stage " + stage + " peds";
                        } else {
                            $("who_stage").value = "WHO stage " + stage + " adult";
                        }
                        $("date_started_art").value = dateFormat(startDate, "yyyy-mm-dd");
                    }

                    function age(birthdate, birthdate_estimated, date_created, today) {
                        patient_age = (today.getFullYear() - birthdate.getFullYear()) + ((today.getFullYear() - (birthdate.getMonth() + 1)) + ((today.getDate() - birthdate.getDate()) < 0 ? -1 : 0) < 0 ? -1 : 0)
                        birth_date = birthdate
                        estimate = birthdate_estimated
                        if (birth_date.month == 7 && birth_date.day == 1 && estimate == 1 && Time.now.month < birth_date.month && date_created.getFullYear() == (new Date().getFullYear())) {
                            return patient_age + 1
                        } else {
                            return patient_age
                        }
                    }

                    function calculateBMI() {
                        var currentWeight = $("weight").value;
                        var currentHeight = $("height").value;
                        currentBmi = (currentWeight / (currentHeight * currentHeight) * 10000).toFixed(1);
                        try {
                            $('bmi').value = currentBmi;
                            answers_hash["bmi"] = currentBmi;
                        } catch (e) {
                        }
                    }

                    function buildDate(type) {
                        if (type.match(/confirmatory/i)) {
                            var year = $("confirmatory_hiv_test_year").value;
                            var year_element = $("confirmatory_hiv_test_year");
                            var month = $("confirmatory_hiv_test_month").value;
                            var month_element = $("confirmatory_hiv_test_month");
                            var day = $("confirmatory_hiv_test_day").value;
                            var day_element = $("confirmatory_hiv_test_day");
                        } else if (type.match(/art_last_taken/i)) {
                            var year = $("year_art_last_taken").value;
                            var year_element = $("year_art_last_taken");
                            var month = $("month_art_last_taken").value;
                            var month_element = $("month_art_last_taken");
                            var day = $("day_art_last_taken").value;
                            var day_element = $("day_art_last_taken");
                        }

                        if (year.length < 1) {
                            if (type.match(/confirmatory/i)) {
                                $("confirmatory_hiv_test_date").value = null;
                            } else if (type.match(/art_last_taken/i)) {
                                $("date_art_last_taken").value = null;
                            }
                            return
                        }

                        if (day.length < 1) {
                            try {
                                var days = day_element;
                                for (i = 0; i < days.length; i++) {
                                    if (days[i].value.length > 0) {
                                        day = days[i].value;
                                        break;
                                    }
                                }
                            } catch (e) {
                                return
                            }
                        }

                        if (month.length == 1)
                            month = 0 + month;

                        if (day.length == 1)
                            day = 0 + day;



                        if (type.match(/confirmatory/i)) {
                            if (year == "Unknown") {
                                $("confirmatory_hiv_test_date").value = year;
                            } else if (month == "Unknown") {
                                $("confirmatory_hiv_test_date").value = year + "-07-01";
                            } else if (day == "Unknown") {
                                $("confirmatory_hiv_test_date").value = year + "-" + month + "-01";
                            } else {
                                $("confirmatory_hiv_test_date").value = year + "-" + month + "-" + day;
                            }
                        } else if (type.match(/art_last_taken/i)) {
                            if (year == "Unknown") {
                                $("date_art_last_taken").value = year;
                            } else if (month == "Unknown") {
                                $("date_art_last_taken").value = year + "-07-01";
                            } else if (day == "Unknown") {
                                $("date_art_last_taken").value = year + "-" + month + "-01";
                            } else {
                                $("date_art_last_taken").value = year + "-" + month + "-" + day;
                            }
                        }
                    }

                    function setUnkownStage() {
                        if ($("has_transfer_letter").value == "YES")
                            return

                        everReceivedARVs = $("ever_received_art").value;
                        everRegisteredAtARTclinic = $("ever_registered_at_ART_clinic").value;

                        if (everRegisteredAtARTclinic == "YES" && everReceivedARVs == "YES" && $("has_transfer_letter").value == "NO") {
                            $("reason_for_art_eligibility").value = "Unknown";
                            $("drug_start_date").value = "Estimated";
                            calculateWHOstage();
                        } else {
                            $("reason_for_art_eligibility").value = null;
                            $("drug_start_date").value = null;
                        }
                    }

                    function setReasonForStarting() {
                        var backButton = $("backButton");
                        backButton.setAttribute("onmousedown", "resetReasonForStarting();gotoPage('" + (tstCurrentPage - 1) + "',null,true);");
                        $("reason_for_art_eligibility").value = null;
                        $("drug_start_date").value = null;
                    }

                    function resetReasonForStarting() {
                        var backButton = $("backButton");
                        backButton.setAttribute("onmousedown", "gotoPage('" + tstCurrentPage + "',null,true);");
                        $("reason_for_art_eligibility").value = null;
                    }

                    function validateDate() {
                        return false;
                    }

                    function showARTstartDate() {
                        if ($("ever_received_art").value == "YES" && $("ever_registered_at_ART_clinic").value == "YES") {
                            if ($("has_transfer_letter").value == "NO" || $("has_transfer_letter").value == "YES")
                                return true
                        }
                        return false
                    }

                    var lastARTDrugs = "";
                    var lastOtherDrugs = "";

                    function updateLastARVDrugs() {
                        lastARTDrugs = $('touchscreenInput' + tstCurrentPage).value;
                    }

                    function updateLastOtherMedications() {
                        lastOtherDrugs = $('touchscreenInput' + tstCurrentPage).value;
                    }

                    function updateReasonForArtEligibility() {

                        if (tstCurrentDate < '2011-07-01') {
                            oldReasonForEligibility();
                            return
                        }

                        var reasonForArtEligibility = "NONE";
                        // Lymphocyte thresholds for ages 0-15
                        var lymphocyteThresholds = [4000, 4000, 4000, 3000, 3000, 2500, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000];

                        var lymphocyteCountAvailable = false;

                        if ($('new_lymphocyte_count_available')) {
                            lymphocyteCountAvailable = $('new_lymphocyte_count_available').value == 'YES';
                        }

                        var lymphocyteCount = lymphocyteCountAvailable ? $('lymphocyte_count').value : null;
                        var lymphocyteCountNumeric = null;

                        try {
                            lymphocyteCountNumeric = parseInt(lymphocyteCount);
                        } catch (e) {
                        }

                        if (age > 14) {
                            if (whoStage >= 3) {
                                reasonForArtEligibility = whoStageConcept(whoStage, "ADULT");
                            }

                            else if (tstCurrentDate >= '2014-04-01' && $('cd4_count_less_than_250').value == "YES") {
                                reasonForArtEligibility = "CD4 count less than or equal to 250"
                            }

                            else if (tstCurrentDate < '2014-04-01' && $('cd4_count_less_than_350').value == "YES") {
                                reasonForArtEligibility = "CD4 COUNT LESS THAN OR EQUAL TO 350";
                            }

                            else if (tstCurrentDate >= '2014-04-01' && $('cd4_count_less_than_350').value == "YES") {
                                reasonForArtEligibility = "CD4 COUNT LESS THAN OR EQUAL TO 350";
                            }

                            else if (tstCurrentDate >= '2014-04-01' && $('cd4_count_less_than_500').value == "YES") {
                                reasonForArtEligibility = "CD4 COUNT LESS THAN OR EQUAL TO 500";
                            }

                            else {
                                if (whoStage == 1 && lymphocyteCount < 1200 && lymphocyteCount != null) {
                                    reasonForArtEligibility = "LYMPHOCYTE COUNT BELOW THRESHOLD WITH WHO STAGE 1";
                                } else if (whoStage == 2 && lymphocyteCount < 1200 && lymphocyteCount != null) {
                                    reasonForArtEligibility = "LYMPHOCYTE COUNT BELOW THRESHOLD WITH WHO STAGE 2";
                                } else if ($('pregnant') && $('pregnant').value == "YES") {
                                    reasonForArtEligibility = "PATIENT PREGNANT";
                                } else if ($('breast_feeding') && $('breast_feeding').value == "YES") {
                                    reasonForArtEligibility = "BREASTFEEDING";
                                }
                            }
                        } else {
                            var presumedSevereHivConditions = "";
                            if ($('presumed_severe_hiv_conditions'))
                                presumedSevereHivConditions = selectedValues($('presumed_severe_hiv_conditions'));
                            var presumedSevereHiv = false;

                            if (firstPositiveHivTestType == "HIV rapid test") {
                                if (
                                presumedSevereHivConditions.indexOf("Pneumocystis pneumonia") > -1 ||
                                    presumedSevereHivConditions.indexOf("Candidiasis of oseophagus, trachea and bronchi or lungs") > -1 ||
                                    presumedSevereHivConditions.indexOf("Cryptococcal meningitis") > -1 ||
                                    presumedSevereHivConditions.indexOf("Severe unexplained wasting or malnutrition not responding to treatment (weight-for-height/ -age <70% or MUAC <11cm or oedema)") > -1 ||
                                    presumedSevereHivConditions.indexOf("Toxoplasmosis of the brain (from age 1 month)") > -1) {
                                    presumedSevereHiv = true;
                                } else if (
                                ((presumedSevereHivConditions.indexOf("Oral candidiasis") > -1) && (presumedSevereHivConditions.indexOf("Severe sepsis") > -1)) ||
                                    ((presumedSevereHivConditions.indexOf("Oral candidiasis") > -1) && (presumedSevereHivConditions.indexOf("Severe pneumonia") > -1)) ||
                                    ((presumedSevereHivConditions.indexOf("Severe pneumonia") > -1) && (presumedSevereHivConditions.indexOf("Severe sepsis") > -1))) {
                                    presumedSevereHiv = true;
                                }
                            }

                            try {
                                if (ageInMonths < 12 && firstPositiveHivTestType == "HIV rapid test" && presumedSevereHiv) {
                                    reasonForArtEligibility = "PRESUMED SEVERE HIV";
                                } else if (whoStage >= 3) {
                                    reasonForArtEligibility = whoStageConcept(whoStage, "PEDS");
                                } else if (ageInMonths < 12 && firstPositiveHivTestType == "HIV DNA POLYMERASE CHAIN REACTION") {
                                    reasonForArtEligibility = "HIV DNA POLYMERASE CHAIN REACTION";
                                } else if (ageInMonths < 24) {
                                    reasonForArtEligibility = "HIV infected";
                                } else if (cd4_count_numeric <= 750 && (ageInMonths >= 24 && ageInMonths < 56) && (whoStage) <= 2) {
                                    reasonForArtEligibility = "CD4 COUNT LESS THAN OR EQUAL TO 750";
                                } else if ($('cd4_count_less_than_500') && $('cd4_count_less_than_500').value == "YES" && (whoStage) <= 2) {
                                    reasonForArtEligibility = "CD4 COUNT LESS THAN OR EQUAL TO 500";
                                } else if (lymphocyteCount && (lymphocyteCount < lymphocyteThresholds[age]) && lymphocyteCount != null) {
                                    reasonForArtEligibility = "LYMPHOCYTE COUNT BELOW THRESHOLD WITH WHO STAGE 2";
                                } else if ($('pregnant') && $('pregnant').value == "YES") {
                                    reasonForArtEligibility = "PATIENT PREGNANT";
                                } else if ($('breast_feeding') && $('breast_feeding').value == "YES") {
                                    reasonForArtEligibility = "BREASTFEEDING";
                                } else if (tstCurrentDate >= '2014-04-01' && age > 5 && $('cd4_count_less_than_500').value == "YES") {
                                    reasonForArtEligibility = "CD4 COUNT LESS THAN OR EQUAL TO 500";
                                } else if (tstCurrentDate >= '2014-04-01' && age <= 5) {
                                    reasonForArtEligibility = "HIV infected";
                                }
                            } catch (e) {
                            }
                        }


                        if (reasonForArtEligibility == "NONE") {
                            reasonForArtEligibility = "Asymptomatic";
                        }
                        //reasonForArtEligibility = "HIV infected";


                        $('reason_for_art_eligibility').value = reasonForArtEligibility;
                        answers_hash["reason_for_art_eligibility"] = reasonForArtEligibility
                    }

                    function oldReasonForEligibility() {
                        var reasonForArtEligibility = "NONE";
                        // Lymphocyte thresholds for ages 0-15
                        var lymphocyteThresholds = [4000, 4000, 4000, 3000, 3000, 2500, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000];

                        var lymphocyteCountAvailable = false;

                        if ($('new_lymphocyte_count_available')) {
                            lymphocyteCountAvailable = $('new_lymphocyte_count_available').value == 'YES';
                        }

                        var lymphocyteCount = lymphocyteCountAvailable ? $('lymphocyte_count').value : null;
                        var lymphocyteCountNumeric = null;

                        try {
                            lymphocyteCountNumeric = parseInt(lymphocyteCount);
                        } catch (e) {
                        }

                        if (age > 14) {
                            if (whoStage >= 3) {
                                reasonForArtEligibility = whoStageConcept(whoStage, "ADULT");
                            } else if ($('cd4_count_less_than_250').value == "YES") {
                                reasonForArtEligibility = "CD4 count less than or equal to 250"
                            } else {
                                if ($('pregnant') && $('pregnant').value == "YES" && $('cd4_count_less_than_250').value == "YES") {
                                    reasonForArtEligibility = "CD4 count less than or equal to 250";
                                } else if (whoStage == 1 && lymphocyteCount < 1200 && lymphocyteCount != null) {
                                    reasonForArtEligibility = "LYMPHOCYTE COUNT BELOW THRESHOLD WITH WHO STAGE 1";
                                } else if (whoStage == 2 && lymphocyteCount < 1200 && lymphocyteCount != null) {
                                    reasonForArtEligibility = "LYMPHOCYTE COUNT BELOW THRESHOLD WITH WHO STAGE 2";
                                } //else if ($('pregnant') && $('pregnant').value == "YES") {
                                //reasonForArtEligibility = "PATIENT PREGNANT";
                                //} else if ($('breast_feeding') && $('breast_feeding').value == "YES") {
                                //reasonForArtEligibility = "BREASTFEEDING";
                                //}
                            }
                        } else {
                            var presumedSevereHivConditions = "";
                            if ($('presumed_severe_hiv_conditions'))
                                presumedSevereHivConditions = selectedValues($('presumed_severe_hiv_conditions'));
                            var presumedSevereHiv = false;

                            if (firstPositiveHivTestType == "HIV rapid test") {
                                if (
                                presumedSevereHivConditions.indexOf("Pneumocystis pneumonia") > -1 ||
                                    presumedSevereHivConditions.indexOf("Candidiasis of oseophagus, trachea and bronchi or lungs") > -1 ||
                                    presumedSevereHivConditions.indexOf("Cryptococcal meningitis") > -1 ||
                                    presumedSevereHivConditions.indexOf("Severe unexplained wasting or malnutrition not responding to treatment (weight-for-height/ -age <70% or MUAC <11cm or oedema)") > -1 ||
                                    presumedSevereHivConditions.indexOf("Toxoplasmosis of the brain (from age 1 month)") > -1) {
                                    presumedSevereHiv = true;
                                } else if (
                                ((presumedSevereHivConditions.indexOf("Oral candidiasis") > -1) && (presumedSevereHivConditions.indexOf("Severe sepsis") > -1)) ||
                                    ((presumedSevereHivConditions.indexOf("Oral candidiasis") > -1) && (presumedSevereHivConditions.indexOf("Severe pneumonia") > -1)) ||
                                    ((presumedSevereHivConditions.indexOf("Severe pneumonia") > -1) && (presumedSevereHivConditions.indexOf("Severe sepsis") > -1))) {
                                    presumedSevereHiv = true;
                                }
                            }

                            try {
                                if (ageInMonths < 12 && firstPositiveHivTestType == "HIV rapid test" && presumedSevereHiv) {
                                    reasonForArtEligibility = "PRESUMED SEVERE HIV";
                                } else if (whoStage >= 3) {
                                    reasonForArtEligibility = whoStageConcept(whoStage, "PEDS");
                                } else if (ageInMonths < 12 && firstPositiveHivTestType == "HIV DNA POLYMERASE CHAIN REACTION") {
                                    reasonForArtEligibility = "HIV DNA POLYMERASE CHAIN REACTION";
                                } else if (ageInMonths < 24) {
                                    reasonForArtEligibility = "HIV infected";
                                } else if (cd4_count_numeric <= 750 && (ageInMonths >= 24 && ageInMonths < 56) && (whoStage) <= 2) {
                                    reasonForArtEligibility = "CD4 COUNT LESS THAN OR EQUAL TO 750";
                                } else if ($('cd4_count_less_than_250') && $('cd4_count_less_than_250').value == "YES" && (whoStage) <= 2) {
                                    reasonForArtEligibility = "CD4 COUNT LESS THAN OR EQUAL TO 250";
                                } else if (lymphocyteCount && (lymphocyteCount < lymphocyteThresholds[age]) && lymphocyteCount != null) {
                                    reasonForArtEligibility = "LYMPHOCYTE COUNT BELOW THRESHOLD WITH WHO STAGE 2";
                                }// else if ($('pregnant') && $('pregnant').value == "YES") {
                                //  reasonForArtEligibility = "PATIENT PREGNANT";
                                //} else if ($('breast_feeding') && $('breast_feeding').value == "YES") {
                                //  reasonForArtEligibility = "BREASTFEEDING";
                                //}
                            } catch (e) {
                            }
                        }

                        $('reason_for_art_eligibility').value = reasonForArtEligibility;
                        answers_hash["reason_for_art_eligibility"] = reasonForArtEligibility;
                    }

                    function summary() {
                        //calculateWHOstage(); //For calculating date started ART - Transfer in patients
                        if (age >= 15) {
                            updateWhoStage();
                        } else {
                            updateWhoStagePaeds() //This is a hack. Take note
                        }

                        updateReasonForArtEligibility();
                        var conditions = selectedConditions();
                        var display = "<div><span class='title'>" + $('who_stage').value + "</span></div>";
                        display += "<div><span class='title'>Condition on starting ART: " + $('reason_for_art_eligibility').value + "</span></div>";

                        $('inputFrame' + tstCurrentPage).innerHTML = '<div id="summary">' + display + '</div>';
                        $("clearButton").style.display = "none";

                        if (conditions.length > 0) {
                            $('inputFrame' + tstCurrentPage).innerHTML += '<div id="selected_stage_conditions"><hr /><br />' + conditions + '</div>';
                        }

                        __$('nextButton').onmousedown = function(){
                            gotoNextPage(); //The Next Button was misbehaving. I couldn't trace where the problem was. mangochiman 2018-12-03 @ 17:42. At least this is working
                        }
                    }

                    function selectedConditions() {
                        html = "<ul><h3>Selected stage defining conditions</h3>"
                        for (condition in selected_stage_conditions) {
                            if (selected_stage_conditions[condition].length > 0) {
                                conditions = selected_stage_conditions[condition].split(';');
                                for (i = 0; i < conditions.length; i++) {
                                    html += '<li>' + conditions[i] + '</li>'
                                }
                            }
                        }
                        if (html == "<ul><h3>Selected stage defining conditions</h3>")
                            return '';
                        return html + '</ul>';
                    }

                    function whoStageConcept(stage, adultOrPeds) {
                        try {
                            selected_stage_three_conditions = selected_stage_conditions[3].split(';');
                        } catch (e) {
                            selected_stage_three_conditions = null;
                        }

                        if (selected_stage_three_conditions) {
                            conditions_found = 0;
                            severe_weight_loss = false;

                            for (i = 0; i < selected_stage_three_conditions.length; i++) {
                                if (selected_stage_three_conditions[i] == 'Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained') {
                                    severe_weight_loss = true;
                                } else if (selected_stage_three_conditions[i] == 'Diarrhoea, chronic (>1 month) unexplained') {
                                    conditions_found++;
                                } else if (selected_stage_three_conditions[i] == 'Fever, persistent unexplained, intermittent or constant, >1 month') {
                                    conditions_found++;
                                }
                            }

                            if (conditions_found > 0 && severe_weight_loss) {

                                selected_stage_conditions[4] = 'HIV wasting syndrome (severe weight loss + persistent fever or severe weight loss + chronic diarrhoea)';
                                $('calculated_who_stage_4').value = selected_stage_conditions[4];


                                return  "WHO STAGE " + numeral(4) + " " + adultOrPeds;
                            }
                        }

                        return "WHO STAGE " + numeral(stage) + " " + adultOrPeds;
                    }

                    function numeral(num) {
                        switch (num) {
                            case 1:
                                return "I";
                            case 2:
                                return "II";
                            case 3:
                                return "III";
                            case 4:
                                return "IV";
                        }
                    }

                    var whoStage = null;

                    function updateWhoStage() {
                        // Everyone is supposed to be HIV positive so start them at 1
                        whoStage = 1;
                        for (var i = 1; i <= 4; i++) {
                            try {

                                if ($("stage_" + i + "_conditions").value != '')
                                    whoStage = i;
                            } catch (e) {

                            }

                        }

                        var adultOrPeds = (age > 14) ? "ADULT" : "PEDS";

                        if (ageInMonths < 12 && firstPositiveHivTestType == "HIV rapid test") {
                            $('who_stage').value = "PRESUMED SEVERE HIV";
                        } else {
                            $('who_stage').value = whoStageConcept(whoStage, adultOrPeds);
                        }

                        answers_hash["who_stage"] = $('who_stage').value;
                    }

                    function updateWhoStagePaeds() {
                        // Everyone is supposed to be HIV positive so start them at 1
                        whoStage = 1;
                        for (var i = 1; i <= 4; i++) {
                            try {

                                if (jQuery(".stage_" + i + "_conditions")[0].value != '')
                                    whoStage = i;
                            } catch (e) {

                            }

                        }

                        var adultOrPeds = "PEDS";
                        $('who_stage').value = whoStageConcept(whoStage, adultOrPeds);
                        answers_hash["who_stage"] = $('who_stage').value;
                    }

                    /*function resetStageDefiningConditions(){
                     selected_stage_conditions = JSON.parse(JSON.stringify(selected_stage_conditions_copy))
                     stage_defining_conditions = __$('touchscreenInput' + tstCurrentPage).value;
                     
                     if (stage_defining_conditions.length > 0){
                     if (stage_defining_conditions.match(/Asymptomatic HIV infection/i)){
                     if (selected_stage_conditions[4]) delete selected_stage_conditions[4]; //Delete Stage 4 conditions
                     if (selected_stage_conditions[3]) delete selected_stage_conditions[3]; //Delete Stage 3 conditions
                     if (selected_stage_conditions[2]) delete selected_stage_conditions[2]; //Delete Stage 2 conditions
                     }
                     }
                     }*/

                    function hideCategory() {
                        document.getElementById('category').style = 'display: none;'
                    }

                    var patientAge = parseInt(sessionStorage.patientAge);
                    var patientGender = "";
                    if (sessionStorage.patientGender == "F"){
                        patientGender = "FEMALE";
                    } else{
                        patientGender = "MALE";
                    }

                    function checkPregnancyAndAge() {
                        if ((patientAge >= 55)) {
                            return "true";
                        } else {
                            return "false";
                        }
                    }

                    function checkBreastfeedingAndAge() {
                        if ((patientAge >= 55)) {
                            return "true";
                        } else {
                            return "false";
                        }
                    }

                    var otherRegimen = false;

                    function addCustomRegimenButton() {
                        /*var button = document.createElement("button");
                         button.id = "customRegimen";
                         button.innerHTML = "<span>Customize Regimen</span>";
                         button.style.cssFloat = "right";
                         otherRegimen = false;
                         __$('touchscreenInput' + tstCurrentPage).removeAttribute("optional", "true");
                         
                         button.onmousedown = function(){
                         __$('touchscreenInput' + tstCurrentPage).value = '';
                         }
                         
                         button.onclick = function(){
                         __$('last_art_drugs_taken').value = '';
                         __$('touchscreenInput' + tstCurrentPage).value = '';
                         otherRegimen = true;
                         
                         
                         var selectedLi = jQuery('li').filter(function () {
                         return this.style.backgroundColor == 'lightblue'
                         });
                         
                         __$('touchscreenInput' + tstCurrentPage).value = '';
                         __$('touchscreenInput' + tstCurrentPage).setAttribute("optional", "true");
                         gotoNextPage();
                         }
                         
                         if(__$("buttons")){
                         __$("buttons").appendChild(button);
                         }*/
                    }

                    function removeCustomRegimenButton() {
                        jQuery("#customRegimen").remove();
                    }

                    function forceStageOneAvailabe() {
                        stage_four_conditions = $('stage_4_conditions');
                        stage_three_conditions = $('stage_3_conditions');
                        stage_two_conditions = $('stage_2_conditions');

                        __$('touchscreenInput' + tstCurrentPage).setAttribute("optional", "true");

                        if ((stage_four_conditions.value.length == 0) && (stage_three_conditions.value.length == 0) && stage_two_conditions.value.length == 0) {
                            __$('touchscreenInput' + tstCurrentPage).removeAttribute("optional");
                        }
                    }

                    function forceStageOneAvailabePaeds() {
                        stage_four_conditions = jQuery('.stage_4_conditions')[0];
                        stage_three_conditions = jQuery('.stage_3_conditions')[0];
                        stage_two_conditions = jQuery('.stage_2_conditions')[0];

                        __$('touchscreenInput' + tstCurrentPage).setAttribute("optional", "true");

                        if ((stage_four_conditions.value.length == 0) && (stage_three_conditions.value.length == 0) && stage_two_conditions.value.length == 0) {
                            __$('touchscreenInput' + tstCurrentPage).removeAttribute("optional");
                        }
                    }


                    function everReceivedARTMonth() {
                        var ever_received_art = $('ever_received_art').value;
                        var ever_registered_at_ART_clinic = $("ever_registered_at_ART_clinic").value;
                        var year_started_art = $("year_started_art").value;

                        if (ever_received_art.toLowerCase() == 'no')
                            return "false";

                        if (ever_registered_at_ART_clinic.toLowerCase() == 'no')
                            return "false";

                        if (year_started_art.toLowerCase() == "unknown")
                            return "false";

                        return "true";
                    }

                    function everReceivedARTDay() {
                        var ever_received_art = $('ever_received_art').value;
                        var ever_registered_at_ART_clinic = $("ever_registered_at_ART_clinic").value;
                        var year_started_art = $("year_started_art").value;
                        var month_started_art = $("month_started_art").value

                        if (ever_received_art.toLowerCase() == 'no')
                            return "false";

                        if (ever_registered_at_ART_clinic.toLowerCase() == 'no')
                            return "false";

                        if (year_started_art.toLowerCase() == "unknown")
                            return "false";

                        if (month_started_art.toLowerCase() == "unknown")
                            return "false";

                        return "true";
                    }



                    function submitHIVClinicRegistration() {
                        var currentTime = moment().format(' HH:mm:ss');
                        var encounter_datetime = moment(sessionStorage.sessionDate).format('YYYY-MM-DD');
                        encounter_datetime += currentTime;

                        var encounter = {
                            encounter_type_id:  9,
                            patient_id: patient_id,
                            encounter_datetime: encounter_datetime
                        }

                        submitParameters(encounter,"/encounters/", "postHIVClinicRegistrationObs");
                    }

                    function submitVitalsRegistration() {

                        if (!(showConditions() == true)){
                            console.log("NOT a transfer in patient. Can't create vitals encounter")
                           return nextPage();
                        }
                        console.log("Creating vitals encounter........")
                        var encounter = {
                            encounter_type_id:  6,
                            patient_id: patient_id,
                            encounter_datetime: answers_hash["date_art_started"]
                        }

                        submitParameters(encounter,"/encounters/", "postVitalsObs");


                    }

                    function submitHIVStaging() {
                        if (!(showConditions() == true)){
                            console.log("NOT a transfer in patient. Can't create HIV staging encounter")
                            return nextPage();
                        }
                        console.log("Creating HIV staging encounter........")
                        var encounter = {
                            encounter_type_id:  52,
                            patient_id: patient_id,
                            encounter_datetime: answers_hash["date_art_started"]
                        }
                        submitParameters(encounter,"/encounters/", "postHIVStagingObs");
                    }

                    var answers_hash = {
                        followup_agreement: "", ever_received_art: "", date_art_last_taken: "",
                        taken_art_in_the_last_two_months: "", taken_art_in_the_last_two_weeks: "",
                        ever_registered: "", drug_art_last_taken: "", location_of_art_initiation: "",
                        drug_start_date: "", date_art_started: "", art_number_at_previous_location: "",
                        has_transfer_letter: "",height: "", weight: "", bmi: "", is_patient_pregnant: "",
                        is_patient_breastfeeding: "",
                        who_stages_criteria_present: "", who_stage: "", cd4_less_than_or_equal_to_250: "",
                        cd4_less_than_or_equal_to_350: "", cd4_less_than_or_equal_to_500: "",
                        cd4_less_than_25: "", reason_for_art_eligibility: "", cd4_location: "",
                        cd4_datetime: "", cd4_count: "", confirmatory_hiv_test_date: "",
                        confirmatory_hiv_test_location: "", confirmatory_hiv_test_type: "",
                        send_sms: "", cd4_percent: ""
                    }

                    function postHIVClinicRegistrationObs(encounter) {
                        var obs = {
                            encounter_id: encounter.encounter_id,
                            observations: [
                                { concept_id: 7937, value_coded: answers_hash["ever_registered"].trim().toUpperCase() == "YES" ? 1065: 1066 },
                                { concept_id: 6393, value_coded: answers_hash["has_transfer_letter"].trim().toUpperCase() == "YES" ? 1065: 1066 },
                                { concept_id: 7881, value_text: answers_hash["confirmatory_hiv_test_location"] },
                                { concept_id: 7880, value_text: answers_hash["confirmatory_hiv_test_type"] }
                            ]
                        };

                        if ($('ever_received_art').value == 'YES'){
                            obs.observations.push({ concept_id: 6981, value_text: answers_hash["art_number_at_previous_location"]});
                            obs.observations.push({ concept_id: 7751, value_datetime: answers_hash["date_art_last_taken"], value_text: date_art_last_taken_value_text});
                            obs.observations.push({ concept_id: 7752, value_coded: answers_hash["taken_art_in_the_last_two_months"].trim().toUpperCase() == "YES" ? 1065: 1066 });
                            obs.observations.push({ concept_id: 6394, value_coded: answers_hash["taken_art_in_the_last_two_weeks"].trim().toUpperCase() == "YES" ? 1065: 1066 });
                            obs.observations.push({ concept_id: 7750, value_text: answers_hash["location_of_art_initiation"]});
                            obs.observations.push({ concept_id: 1499, value_datetime: answers_hash["drug_start_date"]});
                            obs.observations.push({ concept_id: 2516, value_datetime: answers_hash["date_art_started"]});
                            obs.observations.push({ concept_id: 5497, value_numeric: answers_hash["cd4_count"], value_modifier: cd4_count_modifier_global});
                        }

                        var confirmatory_year = $('confirmatory_hiv_test_year').value;
                        var confirmatory_month = $('confirmatory_hiv_test_month').value;
                        var confirmatory_day = __$('touchscreenInput' + tstCurrentPage).value;
                        var current_input = __$('touchscreenInput' + tstCurrentPage).value;

                        if (!current_input.match(/UNKNOWN/i)) {
                            if (isNumeric(confirmatory_year) == true) {
                                if (isNumeric(confirmatory_month) == true) {
                                    var confirmatory_date = confirmatory_year + "-" + confirmatory_month + "-" + confirmatory_day;
                                    var confirmatory_date_check = new Date(confirmatory_date);
                                    if (confirmatory_date_check) {
                                        obs.observations.push({concept_id: 7882, value_datetime: confirmatory_date});
                                    }
                                }
                            }
                        }


                        var agrees_to_followup_agreement_concept_id = 2552;
                        var phone_only_concept_id = 9685;
                        var visit_only_concept_id = 9686;



                        var phone_only_answer_yes_no = yesNo_Hash["AGREES TO FOLLOW UP"]["Phone"];
                        var phone_only_answer_value_coded = getAgreesToFollowUpConceptID(phone_only_answer_yes_no);

                        var visit_only_answer_yes_no = yesNo_Hash["AGREES TO FOLLOW UP"]["Home visit"];
                        var visit_only_answer_value_coded = getAgreesToFollowUpConceptID(visit_only_answer_yes_no);



                        obs.observations.push(
                            {concept_id: agrees_to_followup_agreement_concept_id, value_coded: phone_only_concept_id, child: {concept_id: phone_only_concept_id, value_coded: phone_only_answer_value_coded}}
                        )

                        obs.observations.push(
                            {concept_id: agrees_to_followup_agreement_concept_id, value_coded: visit_only_concept_id, child: {concept_id: visit_only_concept_id, value_coded: visit_only_answer_value_coded}}
                        )


                        submitParameters(obs,"/observations/", "submitVitalsRegistration()");
                    }

                    function isNumeric(num){
                        return !isNaN(num)
                    }

                    function getAgreesToFollowUpConceptID(answer){
                        if (answer.match(/YES/i)){
                            return 1065;
                        }

                        if (answer.match(/NO/i)){
                            return 1066;
                        }

                        return ""
                    }

                    function postVitalsObs(encounter){
                        var obs = {
                            encounter_id: encounter.encounter_id,
                            observations: [
                                { concept_id: 5090, value_numeric: answers_hash["height"]},
                                { concept_id: 5089, value_numeric: answers_hash["weight"]},
                                { concept_id: 2137, value_numeric: answers_hash["bmi"] }                            ]
                        };

                        submitParameters(obs,"/observations/", "submitHIVStaging");
                    }

                    var who_stage_concept_map = {
                        "Cryptococcal meningitis or other extrapulmonary cryptococcosis": 7548,
                        "Candidiasis of oseophagus, trachea and bronchi or lungs": 5340,
                        "Extrapulmonary tuberculosis (EPTB)": 1547,
                        "Kaposis sarcoma": 507,
                        "Bacterial pneumonia, severe recurrent": 1215,
                        "Non-typhoidal Salmonella bacteraemia, recurrent": 7959,
                        "Symptomatic HIV-associated nephropathy or cardiomyopathy": 7957,
                        "Cerebral or B-cell non Hodgkin lymphoma": 2587,
                        "Pneumocystis pneumonia": 882,
                        "Chronic herpes simplex infection (orolabial, gential / anorectal >1 month or visceral at any site)": 5344,
                        "Cytomegalovirus infection (retinitis or infection or other organs)": 7551,
                        "Toxoplasmosis of the brain": 2583,
                        "Invasive cancer of cervix": 2588,
                        "Unspecified stage 4 condition": 7040,
                        "Other": 6408,
                        "Pneumocystis pneumonia": 882,
                        "Candidiasis of oseophagus, trachea and bronchi or lungs": 5340,
                        "Extrapulmonary tuberculosis (EPTB)": 1547,
                        "Kaposis sarcoma": 507,
                        "HIV encephalopathy": 1362,
                        "Cryptococcal meningitis or other extrapulmonary cryptococcosis": 7548,
                        "Disseminated non-tuberculosis mycobacterial infection": 2585,
                        "Cryptosporidiosis, chronic with diarroea": 7549,
                        "Isosporiasis >1 month": 7956,
                        "Disseminated mycosis (coccidiomycosis or histoplasmosis)": 7550,
                        "Symptomatic HIV-associated nephropathy or cardiomyopathy": 7957,
                        "Progressive multifocal leukoencephalopathy": 5046,
                        "Cerebral or B-cell non Hodgkin lymphoma": 2587,
                        "Severe unexplained wasting or malnutrition not responding to treatment (weight-for-height/ -age <70% or MUAC less than 11cm or oedema)": 3068,
                        "Bacterial infections, severe recurrent  (empyema, pyomyositis, meningitis, bone/joint infections but EXCLUDING pneumonia)": 2894,
                        "Chronic herpes simplex infection (orolabial or cutaneous >1 month or visceral at any site)": 7960,
                        "Cytomegalovirus infection: rentinitis or other organ (from age 1 month)": 7552,
                        "Toxoplasmosis of the brain (from age 1 month)": 5048,
                        "Recto-vaginal fistula, HIV-associated": 7961,
                        "Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained": 7540,
                        "Diarrhoea, chronic (>1 month) unexplained": 5018,
                        "Fever, persistent unexplained, intermittent or constant, >1 month": 5027,
                        "Pulmonary tuberculosis (current)": 8206,
                        "Tuberculosis (PTB or EPTB) within the last 2 years": 7539,
                        "Oral candidiasis": 5334,
                        "Anaemia, unexplained < 8 g/dl": 2582,
                        "Neutropaenia, unexplained < 500 /mm(cubed)": 7954,
                        "Severe bacterial infections (pneumonia, empyema, pyomyositis, bone/joint, meningitis, bacteraemia)": 7541,
                        "Thrombocytopaenia, chronic < 50,000 /mm(cubed)": 7955,
                        "Hepatitis B or C infection": 8205,
                        "Oral hairy leukoplakia": 5337,
                        "Unspecified stage 3 condition": 7039,
                        "Fever, persistent unexplained, intermittent or constant, >1 month": 5027,
                        "Oral hairy leukoplakia": 5337,
                        "Pulmonary tuberculosis (current)": 8206,
                        "Tuberculosis (PTB or EPTB) within the last 2 years": 7539,
                        "Anaemia, unexplained < 8 g/dl": 2582,
                        "Neutropaenia, unexplained < 500 /mm(cubed)": 7954,
                        "Thrombocytopaenia, chronic < 50,000 /mm(cubed)": 7955,
                        "Moderate unexplained wasting/malnutrition not responding to treatment (weight-for-height/ -age 70-79% or muac 11-12 cm)": 7543,
                        "Diarrhoea, persistent unexplained (14 days or more)": 7544,
                        "Oral candidiasis (from age 2 months)": 7545,
                        "Acute necrotizing ulcerative gingivitis or periodontitis": 7546,
                        "Lymph node tuberculosis": 7547,
                        "Bacterial pneumonia, severe recurrent": 1215,
                        "Symptomatic lymphoid interstitial pneumonia": 5024,
                        "Chronic HIV-associated lung disease, including bronchiectasis": 2889,
                        "Moderate weight loss less than or equal to 10 percent, unexplained": 5332,
                        "Respiratory tract infections, recurrent (sinusitis, tonsilitus, otitis media, pharyngitis)": 5012,
                        "Seborrhoeic dermatitis": 2578,
                        "Papular pruritic eruptions / Fungal nail infections": 7536,
                        "Herpes zoster": 836,
                        "Angular cheilitis": 2575,
                        "Oral ulcerations, recurrent": 2576,
                        "Unspecified stage 2 condition": 7038,
                        "Respiratory tract infections, recurrent (sinusitis, tonsilitus, otitis media, pharyngitis)": 5012,
                        "Herpes zoster": 836,
                        "Angular cheilitis": 2575,
                        "Oral ulcerations, recurrent": 2576,
                        "Papular pruritic eruptions / Fungal nail infections": 7536,
                        "Hepatosplenomegaly, persistent unexplained": 7537,
                        "Lineal gingival erythema": 2891,
                        "Wart virus infection, extensive": 6775,
                        "Molluscum contagiosum, extensive": 6776,
                        "Parotid enlargement, persistent unexplained": 1210,
                        "Asymptomatic HIV infection": 5327,
                        "Persistent generalized lymphadenopathy": 5328
                    }


                    function postHIVStagingObs(encounter){
                        var obs = {
                            encounter_id: encounter.encounter_id,
                            observations: [
                                { concept_id: 7562, value_text: answers_hash["who_stage"] },
                                { concept_id: 8262, value_text: answers_hash["cd4_less_than_or_equal_to_250"] },
                                { concept_id: 8207, value_text: answers_hash["cd4_less_than_or_equal_to_350"] },
                                { concept_id: 9389, value_text: answers_hash["cd4_less_than_or_equal_to_500"] },
                                { concept_id: 7032, value_text: answers_hash["cd4_less_than_25"] },
                                { concept_id: 7563, value_text: answers_hash["reason_for_art_eligibility"] },
                                { concept_id: 6830, value_text: answers_hash["cd4_location"] },
                                { concept_id: 6831, value_datetime: answers_hash["cd4_datetime"] },
                                { concept_id: 5497, value_numeric: answers_hash["cd4_count"], value_modifier: cd4_count_modifier_global },
                                { concept_id: 730, value_text: answers_hash["cd4_percent"], value_modifier: cd4_percent_modifier_global }
                            ]
                        };

                        if (patientGender == "FEMALE"){
                            obs.observations.push({ concept_id: 6131, value_coded: (answers_hash["is_patient_pregnant"].length > 0 ? (answers_hash["is_patient_pregnant"].trim().toUpperCase() == "YES" ? 1065: 1066): "" )})
                            obs.observations.push({ concept_id: 7965, value_coded: (answers_hash["is_patient_breastfeeding"].length > 0 ? (answers_hash["is_patient_breastfeeding"].trim().toUpperCase() == "YES" ? 1065: 1066): "") })
                        }

                        for (condition in selected_stage_conditions) {
                            if (selected_stage_conditions[condition].length > 0) {
                                conditions = selected_stage_conditions[condition].split(';');
                                for (i = 0; i < conditions.length; i++) {
                                    obs.observations.push({ concept_id: 2743, value_coded: who_stage_concept_map[conditions[i]] })
                                }
                            }
                        }

                        //obs= JSON.stringify(obs);

                        submitParameters(obs,"/observations", "nextPage");
                    }



                    function nextPage(){
                        nextEncounter(sessionStorage.patientID, 1);
                        // alert("Done");
                    }

                    function setNextButtonToGetInputValue(key){
                        __$('nextButton').onmousedown = function(){
                            value = __$('touchscreenInput' + tstCurrentPage).value;
                            answers_hash[key] = value;
                            gotoNextPage();
                        }
                    }

                    function setNextButtonToGetDateARTLastTaken(key){
                        __$('nextButton').onmousedown = function(){
                            year_art_last_taken = $('year_art_last_taken').value
                            month_art_last_taken = $('month_art_last_taken').value
                            day_art_last_taken = __$('touchscreenInput' + tstCurrentPage).value;


                            date_art_last_taken = year_art_last_taken + "-" + month_art_last_taken + "-" + day_art_last_taken
                            answers_hash[key] = date_art_last_taken;
                            gotoNextPage();
                        }
                    }
                    
                    function setNextButtonToGetDateStartedART(key){
                        __$('nextButton').onmousedown = function(){
                            year_started_art = $('year_started_art').value
                            month_started_art = $('month_started_art').value
                            day_started_art = __$('touchscreenInput' + tstCurrentPage).value;

                            art_start_date = year_started_art + "-" + month_started_art + "-" + day_started_art
                            answers_hash[key] = art_start_date;
                            gotoNextPage();
                        }
                    }

                    function setNextButtonToGetCD4(key){
                        __$('nextButton').onmousedown = function(){
                            $('year_of_cd4').value, $('month_of_cd4').value

                            cd4_year = $('year_of_cd4').value
                            cd4_month = $('month_of_cd4').value
                            cd4_day = __$('touchscreenInput' + tstCurrentPage).value;

                            cd4_date = cd4_year + "-" + cd4_month + "-" + cd4_day
                            answers_hash[key] = art_start_date;
                            gotoNextPage();
                        }
                    }

                    function setNextButtonToGetConfirmatoryTestDate(key){
                        __$('nextButton').onmousedown = function(){
                            confirmatory_hiv_test_year = $('confirmatory_hiv_test_year').value
                            confirmatory_hiv_test_month = $('confirmatory_hiv_test_month').value
                            confirmatory_hiv_test_day = __$('touchscreenInput' + tstCurrentPage).value;

                            confirmatory_date = confirmatory_hiv_test_year + "-" + confirmatory_hiv_test_month + "-" + confirmatory_hiv_test_day;
                            answers_hash[key] = art_start_date;
                            gotoNextPage();
                        }
                    }

                    function submitParametersOnUnknownConfirmatoryDate(){
                        var nextButton =  document.getElementById('nextButton');
                        nextButton.onmousedown = function(){
                            value = $('touchscreenInput'+tstCurrentPage).value;
                            if (value.match(/UNKNOWN/i)){
                                submitHIVClinicRegistration();
                                
                            } else{
                                gotoNextPage();
                            }
                        }
                    }

                    function submitParametersOnUnknownConfirmatoryTestType(){
                        var nextButton =  document.getElementById('nextButton');
                        nextButton.onmousedown = function(){
                            value = __$('touchscreenInput' + tstCurrentPage).value;
                            answers_hash["confirmatory_hiv_test_type"] = value;
                            if (value.match(/NOT DONE/i)){
                                submitHIVClinicRegistration();

                            } else{
                                gotoNextPage();
                            }
                        }
                    }


                    var date_art_last_taken_value_text = "";
                    
                    function setDateARTLastTaken(){
                        taken_art_in_the_last_two_months = answers_hash["taken_art_in_the_last_two_months"].toUpperCase();
                        taken_art_in_the_last_two_weeks = answers_hash["taken_art_in_the_last_two_weeks"].toUpperCase();

                        year_art_taken = parseInt(__$("year_art_last_taken").value);
                        month_art_taken = __$("month_art_last_taken").value;
                        day_art_taken = parseInt(__$("day_art_last_taken").value);

                        if (taken_art_in_the_last_two_months == 'YES'){
                            if (taken_art_in_the_last_two_weeks == 'YES'){
                                var date = new Date();
                                date.setDate(date.getDate() - 14); //two weeks
                                date = date.toDateString();
                                answers_hash["date_art_last_taken"] = date;
                                date_art_last_teken_value_text = "Estimated";
                            }
                            if (taken_art_in_the_last_two_weeks == 'NO'){
                                var date = new Date();
                                date.setDate(date.getDate() - 60); // 2 months
                                date = date.toDateString();
                                answers_hash["date_art_last_taken"] = date;
                                date_art_last_taken_value_text = "Estimated";
                            }
                        }

                        if (taken_art_in_the_last_two_months == 'NO'){
                            var date = new Date();
                            date.setDate(date.getDate() - 90); //3 months
                            date = date.toDateString();
                            answers_hash["date_art_last_taken"] = date;
                            date_art_last_taken_value_text = "Estimated";
                        }

                        if (year_art_taken > 1 && month_art_taken != 'Unknown' && !(isNaN(day_art_taken)) && day_art_taken > 0){
                            date = year_art_taken + "/" + month_art_taken + "/" + day_art_taken;
                            answers_hash["date_art_last_taken"] = date;
                        }

                        if (year_art_taken > 1 && month_art_taken == 'Unknown'){
                            date = year_art_taken + "/July/01";
                            answers_hash["date_art_last_taken"] = date;
                            date_art_last_taken_value_text = "Estimated";
                        }
                        else if (year_art_taken > 1 && month_art_taken != 'Unknown' &&  isNaN(day_art_taken)){
                            date = year_art_taken + "/" +  month_art_taken + "/15";
                            answers_hash["date_art_last_taken"] = date;
                            date_art_last_taken_value_text = "Estimated";
                        }

                    }

                    function setDateARTStarted(){
                        year_started_art = parseInt(__$("year_started_art").value);
                        month_started_art = __$("month_started_art").value;
                        day_started_art = parseInt(__$("day_started_art").value);

                        art_start_date_estimation = __$("art_start_date_estimation").value;

                        if (art_start_date_estimation.match(/6 months/i)){
                            var date = new Date();
                            date.setDate(date.getDate() - 180); // 6 months
                            date = date.toDateString();
                            answers_hash["date_art_started"] = date;
                        }

                        if (art_start_date_estimation.match(/12 months/i)){
                            var date = new Date();
                            date.setDate(date.getDate() - 365); // 6 months
                            date = date.toDateString();
                            answers_hash["date_art_started"] = date;
                        }

                        if (art_start_date_estimation.match(/18 months/i)){
                            var date = new Date();
                            date.setDate(date.getDate() - 540); // 6 months
                            date = date.toDateString();
                            answers_hash["date_art_started"] = date;
                        }

                        if (art_start_date_estimation.match(/24 months/i)){
                            var date = new Date();
                            date.setDate(date.getDate() - 730); // 6 months
                            date = date.toDateString();
                            answers_hash["date_art_started"] = date;
                        }

                        if (art_start_date_estimation.match(/Over 2 years/i)){
                            var date = new Date();
                            date.setDate(date.getDate() - 730); // 6 months
                            date = date.toDateString();
                            answers_hash["date_art_started"] = date;
                        }

                        if (year_started_art > 1 && month_started_art != 'Unknown' && day_started_art > 0){
                            date = year_started_art + "/" + month_started_art + "/" + day_started_art;
                            answers_hash["date_art_started"] = date;
                        }

                        if (year_started_art > 1 && month_started_art == 'Unknown'){
                            date = year_started_art + "/July/01";
                            answers_hash["date_art_started"] = date;
                        }
                        else if (year_started_art > 1 && month_started_art != 'Unknown' &&  isNaN(day_started_art)){
                            date = year_started_art + "/" +  month_started_art + "/15";
                            answers_hash["date_art_started"] = date;
                        }

                    }

                    function changeSubmitFunction(){
                        var nextButton =  document.getElementById('nextButton');
                        nextButton.onmousedown = function(){
                            submitHIVClinicRegistration();
                            // alert("Form submitted")
                        }
                    }

                    function showCategory2(category) {
                        if (category.length < 1)
                            return;

                        var pos = checkCtrl(__$("content"));

                        if (__$("category")) {
                            document.body.removeChild(__$("category"));
                        }

                        var cat = document.createElement("div");
                        cat.id = "category";
                        cat.style.position = "absolute";
                        cat.style.right = "10px";
                        cat.style.top = (pos[2] + 2) + "px";
                        cat.style.fontSize = "26px";
                        cat.style.padding = "10px";
                        cat.style.backgroundColor = "#9e9";
                        cat.style.borderColor = "#7c7";
                        cat.style.color = "#000";
                        cat.style.opacity = "0.95";
                        cat.style.zIndex = 100;
                        cat.style.textAlign = "center";
                        cat.style.borderRadius = "30px";
                        cat.innerHTML = category;

                        document.body.appendChild(cat);
                    }


                    setTimeout(function () {showCategory2('')}, 500);

                    function addAgreesToFollowupYesNo() {
                        var concept_name = "AGREES TO FOLLOW UP";
                        var agreesToFollowupConcepts = [
                            ["Phone", 9685],
                            ["Home visit", 9686]
                        ];

                        var frame   = document.getElementById("inputFrame" + tstCurrentPage);
                        var questions  = agreesToFollowupConcepts.join(";").split(";").join("#");

                        buildYesNoUI(concept_name, questions, frame);
                    }

                    function setValidationsTaken() {
                        var maxYear = new Date(sessionStorage.sessionDate).getFullYear();
                        var minYear = new Date(sessionStorage.sessionDate).getFullYear() - 100;
                        $("touchscreenInput" + tstCurrentPage).setAttribute("absoluteMax", maxYear);
                        $("touchscreenInput" + tstCurrentPage).setAttribute("absoluteMin", minYear);
                    }

                    function setAbsoluteMaxYear(){
                        var element = document.getElementById('touchscreenInput' + tstCurrentPage);
                        element.setAttribute("absoluteMax", (new Date().getFullYear()));
                        element.setAttribute("min", (new Date().getFullYear() - 100)); 
                        element.setAttribute("absoluteMin", (new Date().getFullYear() - 120)); 
                    }

                </script>

                <form  onsubmit="submitParameters();">

                    <input type="text" name="side-effects"
                           tt_onLoad="__$('keyboard').style.display = 'none'; addAgreesToFollowupYesNo();"
                           optional="true"
                           tt_pageStyleClass= "NoControls"
                           helpText="Agrees to follow-up" />


                    <!--<select tt_onLoad="setNextButtonToGetInputValue('followup_agreement')" name="follow_up_agreement" allowFreeText="false" helpText="Agrees to be contacted by phone/visited at home?" id="agrees_to_followup" tt_pageStyleClass="NoKeyboard">
                        <option value=""></option>
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                    </select>-->

                    <select tt_onLoad="setNextButtonToGetInputValue('ever_received_art')" allowFreeText="false" id="ever_received_art" name="ever_received_art" helpText="Ever received ARVs for treatment or prophylaxis?" name="observations[][value_coded_or_text]" tt_pageStyleClass="NoKeyboard">
                        <option value=''></option>
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                    </select>

                    <input tt_onLoad ="__$('Unknown').style.display='inline'; setValidationsTaken();"  condition="$('ever_received_art').value == 'YES'" field_type="number" helpText="Year last taken ARVs<span style='font-size:0.7em;font-style:italic'> (Chaka chimene munamwa ma ARV komaliza ndi chiti?)</span>" id="year_art_last_taken" min="1882" name="year_art_last_taken" tt_pageStyleClass="Numeric NumbersOnly" type="text" />

                    <select condition="$('year_art_last_taken').value.toLowerCase() != 'unknown' && $('ever_received_art').value == 'YES'" helpText="Month last taken ARVs<span style='font-size:0.7em;font-style:italic'> (Mwezi umene munamwa ma ARV komaliza ndi uti?)</span>" id="month_art_last_taken" name="month_art_last_taken" tt_onLoad="__$('keyboard').style.display = 'none'; validateMonthARTTaken()" validationMessage="Please enter a valid date">
                        <option value=""></option>
                        <option value="1">Jan</option>
                        <option value="2">Feb</option>
                        <option value="3">Mar</option>
                        <option value="4">Apr</option>
                        <option value="5">May</option>
                        <option value="6">Jun</option>
                        <option value="7">Jul</option>
                        <option value="8">Aug</option>
                        <option value="9">Sep</option>
                        <option value="10">Oct</option>
                        <option value="11">Nov</option>
                        <option value="12">Dec</option>
                        <option value="Unknown">Unknown</option>
                    </select>

                    <input condition="($('year_art_last_taken').value !='Unknown') && ($('month_art_last_taken').value != 'Unknown') && $('ever_received_art'). value == 'YES'" field_type="number" helpText="Day last taken ARVs<span style='font-size:0.7em;font-style:italic'> (Tsiku limene munamwa ma ARV komaliza ndi liti?)</span>" id="day_art_last_taken" name="day_art_last_taken" tt_onLoad="getDayOfMonthPicker($('year_art_last_taken').value, $('month_art_last_taken').value);$('nextButton').style.display = 'block'; validateDayARTTaken(); setNextButtonToGetDateARTLastTaken('date_art_last_taken')" tt_onUnLoad="updateTestDate();" type="text" validationCode="checkTestDate(this);" validationMessage="Date ARV last taken out of range" />
                    <input allowFreeText="false" id="date_art_last_taken" name="observations[][value_datetime]" type="hidden" value_datetime="true" />

                    <select tt_onLoad="setNextButtonToGetInputValue('taken_art_in_the_last_two_months')" allowFreeText="false" condition="$('year_art_last_taken').value.toUpperCase() == 'UNKNOWN'" helpText="Taken ARV&apos;s in the last two months? <span style='font-size:0.7em;font-style:italic'>(Kodi mwamwa ma ARV m'miyezi iwiri yapitayi?)</span>" id="taken_art_in_last_two_months" name="observations[][value_coded_or_text]" tt_pageStyleClass="NoKeyboard">
                        <option value=''></option>
                        <option value=""></option>
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                        <option value="UNKNOWN">Unknown</option>
                    </select>

                    <select tt_onLoad="setNextButtonToGetInputValue('taken_art_in_the_last_two_weeks')" allowFreeText="false" condition="$('taken_art_in_last_two_months').value == 'YES' && $('year_art_last_taken').value.toUpperCase() == 'UNKNOWN'" helpText="Taken ARV's in the last two weeks? <span style='font-size:0.7em;font-style:italic'>(Kodi mwamwa ma ARV sabata ziwiri zapitazi?)</span>" id="taken_art_in_last_two_weeks" name="observations[][value_coded_or_text]" tt_pageStyleClass="NoKeyboard">
                        <option value=''></option>
                        <option value=""></option>
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                        <option value="UNKNOWN">Unknown</option>
                    </select>

                    <select tt_onLoad="setNextButtonToGetInputValue('ever_registered'); setDateARTLastTaken();" allowFreeText="false" condition="$('ever_received_art').value == 'YES'" helpText="Ever registered at an ART clinic?" id="ever_registered_at_ART_clinic" name="observations[][value_coded_or_text]" tt_pageStyleClass="NoKeyboard">
                        <option value=''></option>
                        <option value=""></option>
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                    </select>

                    <select objectType="location" ajaxURL="/locations?name=" allowFreeText="true" condition="$('ever_registered_at_ART_clinic').value == 'YES' && $('ever_received_art').value == 'YES'" field_type="alpha" helpText="Location of ART initiation" id="location_of_art_initialization" name="observations[][value_coded_or_text]" tt_onLoad="showCategory2('when starting ART'); setNextButtonToGetInputValue('location_of_art_initiation')" tt_onUnLoad="hideCategory()"></select>

                    <input absoluteMin="1890" condition="$('ever_received_art').value == 'YES' && $('ever_registered_at_ART_clinic').value == 'YES'" field_type="number" helpText="Year started ART" id="year_started_art" min="1940" name="year_started_art" tt_onLoad="jQuery('#Unknown').show(); showCategory2('when starting ART'); setAbsoluteMaxYearStartedART();" tt_onUnLoad="hideCategory()" tt_pageStyleClass="Numeric NumbersOnly" type="text" />

                    <select allowFreeText="false" condition="$('year_started_art').value.toUpperCase() == 'UNKNOWN'" helpText="Estimated time since ART initiation" id="art_start_date_estimation" name="art_start_date_estimation" ttMatchFromBeginning="true" tt_onLoad="showCategory2('when starting ART');setReasonForStarting();" tt_onUnLoad="hideCategory();setUnkownStage();">
                        <option value=""></option>
                        <option value="6 months">6 months</option>
                        <option value="12 months">12 months</option>
                        <option value="18 months">18 months</option>
                        <option value="24 months">24 months</option>
                        <option value="Over 2 years">Over 2 years</option>
                    </select>

                    <input allowFreeText="false" id="drug_start_date" name="observations[][value_datetime]" type="hidden" value="" value_datetime="true" />
                    <input allowFreeText="false" id="date_started_art" name="observations[][value_datetime]" type="hidden" value="" value_datetime="true" />
                    <select condition="everReceivedARTMonth() == 'true';" helpText="Month started ART" id="month_started_art" name="month_started_art" tt_onLoad="showCategory2('when starting ART'); __$('keyboard').style.display = 'none'; validateMonthStartedART();" tt_onUnLoad="hideCategory(); setUnkownStage();" validationMessage="Please enter a valid date">
                        <option value=""></option>
                        <option value="1">Jan</option>
                        <option value="2">Feb</option>
                        <option value="3">Mar</option>
                        <option value="4">Apr</option>
                        <option value="5">May</option>
                        <option value="6">Jun</option>
                        <option value="7">Jul</option>
                        <option value="8">Aug</option>
                        <option value="9">Sep</option>
                        <option value="10">Oct</option>
                        <option value="11">Nov</option>
                        <option value="12">Dec</option>
                        <option value="Unknown">Unknown</option>
                    </select>

                    <!-- <input tt_onLoad="setNextButtonToGetDateStartedART('date_art_started')" condition="everReceivedARTDay() == 'true';" field_type="number" helpText="Day started ART" id="day_started_art" name="day_started_art" tt_onLoad="showCategory2('when starting ART');getDayOfMonthPicker($('year_started_art').value, $('month_started_art').value);$('nextButton').style.display = 'block';validateDayStartedART();" tt_onUnLoad="hideCategory();updateStartDate();setUnkownStage();" type="text" validationCode="checkStartDate();" validationMessage="Date ART started out of range  and 2018-09-18" /> -->

                    <input condition="everReceivedARTDay() == 'true';" field_type="number" helpText="Day started ART" id="day_started_art" name="day_started_art" tt_onLoad="showCategory2('when starting ART');getDayOfMonthPicker($('year_started_art').value, $('month_started_art').value);$('nextButton').style.display = 'block';validateDayStartedART(); setNextButtonToGetDateStartedART('date_art_started');" tt_onUnLoad="hideCategory();updateStartDate();setUnkownStage();" type="text" validationCode="checkStartDate();" validationMessage="Date ART started out of range  and 2018-09-18" />

                    <input allowFreeText="true" condition="$('ever_registered_at_ART_clinic').value == 'YES' && $('ever_received_art').value == 'YES'" field_type="alpha" helpText="ART number at previous location" id="previous_art_number" name="observations[][value_text]" tt_onLoad="setDateARTStarted(); showCategory2('when starting ART'); setNextButtonToGetInputValue('art_number_at_previous_location')" tt_onUnLoad="hideCategory()" type="text" />

                    <select tt_onLoad="setNextButtonToGetInputValue('has_transfer_letter')"  allowFreeText="false" condition="$('ever_registered_at_ART_clinic').value == 'YES' && $('ever_received_art').value == 'YES'" helpText="Has staging information?" id="has_transfer_letter" name="observations[][value_coded_or_text]" tt_onLoad="showCategory2('when starting ART')" tt_onUnLoad="hideCategory()" tt_onUnload="$('programs__states__state').value = 'Patient transferred in'" tt_pageStyleClass="NoKeyboard">
                        <option value=''></option>
                        <option value=""></option>
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                    </select>

                    <input id="height"  absoluteMax="228" absoluteMin="10" condition="showConditions()" field_type="number" helpText="Height (CM)" id="height" max="183.0" min="0.0" name="observations[][value_numeric]" tt_onLoad="showCategory2('when starting ART'); setNextButtonToGetInputValue('height') " tt_onUnLoad="hideCategory(); setNextButtonToGetInputValue('height')" tt_pageStyleClass="Numeric NumbersOnly" type="text" units="cm" validationMessage="You must enter numbers only (for example 157)" validationRule="^([0-9]+)|Unknown$" />

                    <input id="weight" absoluteMax="250" absoluteMin="0" condition="showConditions()" field_type="number" helpText="Weight (Kg)" id="weight" max="80.0" min="0.0" name="observations[][value_numeric]" tt_onLoad="showCategory2('when starting ART'); setNextButtonToGetInputValue('weight');" tt_onUnLoad="hideCategory();calculateBMI();" tt_pageStyleClass="Numeric NumbersOnlyWithDecimal" type="text" units="kg" validationMessage="You must enter a decimal between 0 and 9 (for example: 54<b>.6</b>)" validationRule="([0-9]+\.[0-9])|Unknown$" />

                    <input id="bmi" name="observations[][value_numeric]" type="hidden" />

                    <select allowFreeText="false" condition="patientGender != 'MALE' && showConditions() == true" helpText="Pregnant at initiation?" id="pregnant" name="observations[][value_coded_or_text]" tt_onLoad="showCategory2('when starting ART'); setNextButtonToGetInputValue('is_patient_pregnant');" tt_onUnLoad="hideCategory();" tt_pageStyleClass="NoKeyboard">
                        <option value=''></option>
                        <option value=""></option>
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                        <option value="UNKNOWN">Unknown</option>
                    </select>

                    <select allowFreeText="false" condition="patientGender != 'MALE' && showConditions() == true" helpText="Breastfeeding at initiation?" id="breast_feeding" name="observations[][value_coded_or_text]" tt_onLoad="showCategory2('when starting ART'); setNextButtonToGetInputValue('is_patient_breastfeeding');" tt_onUnLoad="hideCategory();" tt_pageStyleClass="NoKeyboard">
                        <option value=''></option>
                        <option value=""></option>
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                        <option value="UNKNOWN">Unknown</option>
                    </select>

                    <select allowFreeText="false" condition="showConditions() == true && age >= 15" helpText="Stage 4 Conditions" id="stage_4_conditions" multiple="multiple" name="observations[][value_coded_or_text_multiple][]" optional="true" tt_onLoad="showCategory2('when starting ART'); hideTextInput(); displayCountOfSelectedConditions(); setNextButtonToGetInputValue('who_stages_criteria_present');" tt_onUnLoad="hideCategory();setSelectedStageConditions(4); setNextButtonToGetInputValue('is_patient_breastfeeding');" tt_pageStyleClass="NoKeyboard NoInput small">
                        <option value=''></option>
                        <option value="7548">Cryptococcal meningitis or other extrapulmonary cryptococcosis</option>
                        <option value="5340">Candidiasis of oseophagus, trachea and bronchi or lungs</option>
                        <option value="1547">Extrapulmonary tuberculosis (EPTB)</option>
                        <option value="507">Kaposis sarcoma</option>
                        <option value="1215">Bacterial pneumonia, severe recurrent</option>
                        <option value="7959">Non-typhoidal Salmonella bacteraemia, recurrent</option>
                        <option value="7957">Symptomatic HIV-associated nephropathy or cardiomyopathy</option>
                        <option value="2587">Cerebral or B-cell non Hodgkin lymphoma</option>
                        <option value="882">Pneumocystis pneumonia</option>
                        <option value="5344">Chronic herpes simplex infection (orolabial, gential / anorectal >1 month or visceral at any site)</option>
                        <option value="7551">Cytomegalovirus infection (retinitis or infection or other organs)</option>
                        <option value="2583">Toxoplasmosis of the brain</option>
                        <option value="2588">Invasive cancer of cervix</option>
                        <option value="7040">Unspecified stage 4 condition</option>
                        <option value="6408">Other</option>
                    </select>

                    <select allowFreeText="false" class="stage_4_conditions" condition="showConditions() == true && age <= 14" helpText="Stage 4 Conditions" id="stage_4_conditions" multiple="multiple" name="observations[][value_coded_or_text_multiple][]" optional="true" tt_onLoad="showCategory2('when starting ART'); preselectSevereWeightLossPaeds(); hideTextInput(); displayCountOfSelectedConditions(); setNextButtonToGetInputValue('who_stages_criteria_present');" tt_onUnLoad="hideCategory();setSelectedStageConditions(4);" tt_pageStyleClass="NoKeyboard NoInput small">
                        <option value=''></option>
                        <option value="882">Pneumocystis pneumonia</option>
                        <option value="5340">Candidiasis of oseophagus, trachea and bronchi or lungs</option>
                        <option value="1547">Extrapulmonary tuberculosis (EPTB)</option>
                        <option value="507">Kaposis sarcoma</option>
                        <option value="1362">HIV encephalopathy</option>
                        <option value="7548">Cryptococcal meningitis or other extrapulmonary cryptococcosis</option>
                        <option value="2585">Disseminated non-tuberculosis mycobacterial infection</option>
                        <option value="7549">Cryptosporidiosis, chronic with diarroea</option>
                        <option value="7956">Isosporiasis >1 month</option>
                        <option value="7550">Disseminated mycosis (coccidiomycosis or histoplasmosis)</option>
                        <option value="7957">Symptomatic HIV-associated nephropathy or cardiomyopathy</option>
                        <option value="5046">Progressive multifocal leukoencephalopathy</option>
                        <option value="2587">Cerebral or B-cell non Hodgkin lymphoma</option>
                        <option value="3068">Severe unexplained wasting or malnutrition not responding to treatment (weight-for-height/ -age <70% or MUAC less than 11cm or oedema)</option>
                        <option value="2894">Bacterial infections, severe recurrent  (empyema, pyomyositis, meningitis, bone/joint infections but EXCLUDING pneumonia)</option>
                        <option value="7960">Chronic herpes simplex infection (orolabial or cutaneous >1 month or visceral at any site)</option>
                        <option value="7552">Cytomegalovirus infection: rentinitis or other organ (from age 1 month)</option>
                        <option value="5048">Toxoplasmosis of the brain (from age 1 month)</option>
                        <option value="7961">Recto-vaginal fistula, HIV-associated</option>
                    </select>

                    <select allowFreeText="false" condition="showConditions() == true && age >= 15" helpText="Stage 3 Conditions" id="stage_3_conditions" multiple="multiple" name="observations[][value_coded_or_text_multiple][]" optional="true" tt_onLoad="showCategory2('when starting ART'); preselectSevereWeightLoss(); disableSevereWeightLossInputForNormalBMI(); hideTextInput(); displayCountOfSelectedConditions(); setNextButtonToGetInputValue('who_stages_criteria_present');" tt_onUnLoad="hideCategory();setSelectedStageConditions(3);" tt_pageStyleClass="NoKeyboard NoInput small">
                        <option value=''></option>
                        <option value="7540">Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained</option>
                        <option value="5018">Diarrhoea, chronic (>1 month) unexplained</option>
                        <option value="5027">Fever, persistent unexplained, intermittent or constant, >1 month</option>
                        <option value="8206">Pulmonary tuberculosis (current)</option>
                        <option value="7539">Tuberculosis (PTB or EPTB) within the last 2 years</option>
                        <option value="5334">Oral candidiasis</option>
                        <!--
                        <option value="Acute necrotizing ulcerative stomatitis, gingivitis or periodontitis">Acute necrotizing ulcerative stomatitis, gingivitis or periodontitis</option>
                        -->
                        <option value="2582">Anaemia, unexplained < 8 g/dl</option>
                        <option value="7954">Neutropaenia, unexplained < 500 /mm(cubed)</option>
                        <option value="7541">Severe bacterial infections (pneumonia, empyema, pyomyositis, bone/joint, meningitis, bacteraemia)</option>
                        <option value="7955">Thrombocytopaenia, chronic < 50,000 /mm(cubed)</option>
                        <option value="8205">Hepatitis B or C infection</option>
                        <option value="5337">Oral hairy leukoplakia</option>
                        <option value="7039">Unspecified stage 3 condition</option>
                    </select>

                    <select allowFreeText="false" class="stage_3_conditions" condition="showConditions() == true && age <= 14" helpText="Stage 3 Conditions" id="stage_3_conditions" multiple="multiple" name="observations[][value_coded_or_text_multiple][]" optional="true" tt_onLoad="showCategory2('when starting ART'); preselectModerateWeightLossPaeds(); hideTextInput(); displayCountOfSelectedConditions(); setNextButtonToGetInputValue('who_stages_criteria_present');" tt_onUnLoad="hideCategory();setSelectedStageConditions(3);" tt_pageStyleClass="NoKeyboard NoInput small">
                        <option value=''></option>
                        <option value="5027">Fever, persistent unexplained, intermittent or constant, >1 month</option>
                        <option value="5337">Oral hairy leukoplakia</option>
                        <option value="8206">Pulmonary tuberculosis (current)</option>
                        <option value="7539">Tuberculosis (PTB or EPTB) within the last 2 years</option>
                        <option value="2582">Anaemia, unexplained < 8 g/dl</option>
                        <option value="7954">Neutropaenia, unexplained < 500 /mm(cubed)</option>
                        <option value="7955">Thrombocytopaenia, chronic < 50,000 /mm(cubed)</option>
                        <option value="7543">Moderate unexplained wasting/malnutrition not responding to treatment (weight-for-height/ -age 70-79% or muac 11-12 cm)</option>
                        <option value="7544">Diarrhoea, persistent unexplained (14 days or more)</option>
                        <option value="7545">Oral candidiasis (from age 2 months)</option>
                        <option value="7546">Acute necrotizing ulcerative gingivitis or periodontitis</option>
                        <option value="7547">Lymph node tuberculosis</option>
                        <option value="1215">Bacterial pneumonia, severe recurrent</option>
                        <option value="5024">Symptomatic lymphoid interstitial pneumonia</option>
                        <option value="2889">Chronic HIV-associated lung disease, including bronchiectasis</option>
                    </select>

                    <select allowFreeText="false" condition="showConditions() == true && age >= 15" helpText="Stage 2 Conditions" id="stage_2_conditions" multiple="multiple" name="observations[][value_coded_or_text_multiple][]" optional="true" tt_onLoad="showCategory2('when starting ART'); preselectModerateWeightLoss(); disableModerateWeightLossOptionForNormalBMI(); hideTextInput(); displayCountOfSelectedConditions(); setNextButtonToGetInputValue('who_stages_criteria_present');" tt_onUnLoad="hideCategory();setSelectedStageConditions(2);" tt_pageStyleClass="NoKeyboard NoInput small">
                        <option value=''></option>
                        <option value="5332">Moderate weight loss less than or equal to 10 percent, unexplained</option>
                        <option value="5012">Respiratory tract infections, recurrent (sinusitis, tonsilitus, otitis media, pharyngitis)</option>
                        <option value="2578">Seborrhoeic dermatitis</option>
                        <option value="7536">Papular pruritic eruptions / Fungal nail infections</option>
                        <option value="836">Herpes zoster</option>
                        <option value="2575">Angular cheilitis</option>
                        <option value="2576">Oral ulcerations, recurrent</option>
                        <option value="7038">Unspecified stage 2 condition</option>
                    </select>

                    <select allowFreeText="false" class="stage_2_conditions" condition="showConditions() == true && age <= 14" helpText="Stage 2 Conditions" id="stage_2_conditions" multiple="multiple" name="observations[][value_coded_or_text_multiple][]" optional="true" tt_onLoad="showCategory2('when starting ART'); hideTextInput(); displayCountOfSelectedConditions(); setNextButtonToGetInputValue('who_stages_criteria_present');" tt_onUnLoad="hideCategory();setSelectedStageConditions(2);" tt_pageStyleClass="NoKeyboard NoInput small">
                        <option value=''></option>
                        <option value="5012">Respiratory tract infections, recurrent (sinusitis, tonsilitus, otitis media, pharyngitis)</option>
                        <option value="836">Herpes zoster</option>
                        <option value="2575">Angular cheilitis</option>
                        <option value="2576">Oral ulcerations, recurrent</option>
                        <option value="7536">Papular pruritic eruptions / Fungal nail infections</option>
                        <option value="7537">Hepatosplenomegaly, persistent unexplained</option>
                        <option value="2891">Lineal gingival erythema</option>
                        <option value="6775">Wart virus infection, extensive</option>
                        <option value="6776">Molluscum contagiosum, extensive</option>
                        <option value="1210">Parotid enlargement, persistent unexplained</option>
                    </select>

                    <select allowFreeText="false" condition="showConditions() == true && age >= 15" helpText="Stage 1 Conditions" id="stage_1_conditions" multiple="multiple" name="observations[][value_coded_or_text_multiple][]" optional="true" tt_onLoad="hideCategory();setOptionsForContraindicationsPopup(); forceStageOneAvailabe(); hideTextInput(); displayCountOfSelectedConditions(); setNextButtonToGetInputValue('who_stages_criteria_present');" tt_onUnLoad="showCategory2('when starting ART');setSelectedStageConditions(1); resetStageDefiningConditions();" tt_pageStyleClass="NoKeyboard NoInput small">
                        <option value=''></option>
                        <option value="5327">Asymptomatic HIV infection</option>
                        <option value="5328">Persistent generalized lymphadenopathy</option>
                    </select>

                    <select allowFreeText="false" class="stage_1_conditions" condition="showConditions() == true && age <= 14" helpText="Stage 1 Conditions" id="stage_1_conditions" multiple="multiple" name="observations[][value_coded_or_text_multiple][]" optional="true" tt_onLoad="hideCategory();setOptionsForContraindicationsPopup(); forceStageOneAvailabePaeds(); hideTextInput(); displayCountOfSelectedConditions(); setNextButtonToGetInputValue('who_stages_criteria_present');" tt_onUnLoad="showCategory2('when starting ART');setSelectedStageConditions(1); resetStageDefiningConditions();" tt_pageStyleClass="NoKeyboard NoInput small">
                        <option value=''></option>
                        <option value="5327">Asymptomatic HIV infection</option>
                        <option value="5328">Persistent generalized lymphadenopathy</option>
                    </select>

                    <input allowFreeText="false" id="who_stage" name="observations[][value_coded_or_text]" type="hidden" value="" />

                    <input allowFreeText="false" id="cd4_count_less_than_350" name="observations[][value_coded_or_text]" type="hidden" value="" />

                    <input allowFreeText="false" id="cd4_count_less_than_500" name="observations[][value_coded_or_text]" type="hidden" value="" />

                    <input allowFreeText="false" id="cd4_percent_less_than_25" name="observations[][value_coded_or_text]" type="hidden" value="" />

                    <input allowFreeText="false" id="reason_for_art_eligibility" name="observations[][value_coded_or_text]" type="hidden" value="" />

                    <select condition="showConditions()" helpText="CD4 Count available" id="new_cd4_count_available" name="new_cd4_count_available" tt_pageStyleClass="NoKeyboard">
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                    </select>

                    <select objectType="location" ajaxURL="/locations?name=" allowFreeText="true" condition="$('new_cd4_count_available').value == 'YES' && showConditions()" field_type="alpha" helpText="CD4 Count Location" id="cd4_count_location" name="observations[][value_coded_or_text]" tt_onLoad="showCategory2('when starting ART'); setNextButtonToGetInputValue('cd4_location');" tt_onUnLoad="hideCategory();"></select>

                    <input absoluteMin="1890" condition="$('new_cd4_count_available').value == 'YES' && showConditions()" field_type="number" helpText="Year of CD4 count" id="year_of_cd4" min="1940" name="year_of_cd4" tt_onLoad="showCategory2('when starting ART'); setAbsoluteMaxCD4Year();" tt_onUnLoad="hideCategory();" tt_pageStyleClass="Numeric NumbersOnly" type="text" />

                    <select condition="$('year_of_cd4').value.toLowerCase() != 'unknown' && $('new_cd4_count_available').value == 'YES' && showConditions()" helpText="Month of CD4 count" id="month_of_cd4" name="month_of_cd4" tt_onLoad="showCategory2('when starting ART'); validateCD4Month();" tt_onUnLoad="hideCategory();" validationMessage="Please enter a valid date">
                        <option value=""></option>
                        <option value="1">Jan</option>
                        <option value="2">Feb</option>
                        <option value="3">Mar</option>
                        <option value="4">Apr</option>
                        <option value="5">May</option>
                        <option value="6">Jun</option>
                        <option value="7">Jul</option>
                        <option value="8">Aug</option>
                        <option value="9">Sep</option>
                        <option value="10">Oct</option>
                        <option value="11">Nov</option>
                        <option value="12">Dec</option>
                        <option value="Unknown">Unknown</option>
                    </select>

                    <input condition="($('year_of_cd4').value !='Unknown') && ($('month_of_cd4').value != 'Unknown') && ($('new_cd4_count_available').value == 'YES') && showConditions()" field_type="number" helpText="Day of CD4 count" id="day_of_cd4" name="day_art_last_taken" tt_onLoad="showCategory2('when starting ART');getDayOfMonthPicker($('year_of_cd4').value, $('month_of_cd4').value);$('nextButton').style.display = 'block'; validateCD4Day(); setNextButtonToGetDateStartedART('cd4_datetime')" tt_onUnLoad="hideCategory();checkCd4Date();" type="text" />

                    <input allowFreeText="false" id="cd4_count_date" name="observations[][value_datetime]" type="hidden" value_datetime="true" />

                    <input absoluteMin="0.0" condition="$('new_cd4_count_available').value == 'YES' && showConditions()" field_type="number" helpText="CD4 Count" id="cd4_count" max="1000" min="1" name="observations[][value_numeric]" tt_onLoad="showCategory2('when starting ART');updateCD4CountKeyPad(); setNextButtonToGetInputValue('cd4_count');" tt_onUnLoad="hideCategory();updateCD4Count();" tt_pageStyleClass="Numeric NumbersOnly" type="text" units="cells/mm3" validationMessage="You must enter a modifier plus numbers only (for example =90)" validationRule="^(>|<|=)([0-9.]+)$|Unknown$" />

                    <input allowFreeText="false" id="cd4_count_less_than_250" name="observations[][value_coded_or_text]" type="hidden" value="" />

                    <input allowFreeText="false" id="cd4_count_less_than_350" name="observations[][value_coded_or_text]" type="hidden" value="" />

                    <select condition="showConditions() == true" helpText="CD4 percent available" id="new_cd4_percent_available" name="new_cd4_percent_available" tt_onLoad="showCategory2('when starting ART')" tt_onUnLoad="hideCategory();" tt_pageStyleClass="NoKeyboard">
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                    </select>

                    <input condition="$('new_cd4_percent_available').value == 'YES' && showConditions()" field_type="number" helpText="CD4 Percent" id="cd4_percent" name="observations[][value_numeric]" tt_onLoad="showCategory2('when starting ART');updateCD4CountKeyPad(); setNextButtonToGetInputValue('cd4_percent');" tt_onUnLoad="hideCategory();updateCD4Percent()" tt_pageStyleClass="Numeric NumbersOnly" type="text" units="%" validationMessage="You must enter a modifier plus numbers only (for example =90)" validationRule="^(>|<|=)([0-9.]+)$|Unknown$" />

                    <input allowFreeText="false" id="cd4_percent_less_than_25" name="observations[][value_coded_or_text]" type="hidden" value="" />

                    <input allowFreeText="false" id="who_stage" name="observations[][value_coded_or_text]" type="hidden" value="" />

                    <label for='summary'>Summary</label>
                    <input condition="$('has_transfer_letter').value == 'YES'" id="summary" name="summary" optional="true" tt_onLoad="summary();__$('keyboard').style.display = 'none';" tt_pageStyleClass="NoControls" type="text" />

                    <select allowFreeText="false" helpText="Confirmatory HIV test" id="type_of_confirmatory_hiv_test" name="observations[][value_coded_or_text]" tt_onLoad="setUnknownConfirmatoryTestForPopup(); submitParametersOnUnknownConfirmatoryTestType();" tt_pageStyleClass="NoKeyboard">
                        <option value=''></option>
                        <option value="HIV RAPID TEST">Rapid antibody test</option>
                        <option value="HIV DNA polymerase chain reaction">DNA PCR</option>
                        <option value="NOT DONE">Not done</option>
                    </select>

                    <!--<select allowFreeText="false" tt_onLoad="setNextButtonToGetInputValue('send_sms');" helpText="Can we contact you for HIV care follow-up?" id="send_sms" name="observations[][value_coded_or_text]" tt_pageStyleClass="NoKeyboard">
                        <option value=''></option>
                        <option value=""></option>
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                        <option value="UNKNOWN">Unknown</option>
                    </select>-->

                    <select objectType="location" tt_onLoad="setNextButtonToGetInputValue('confirmatory_hiv_test_location');" ajaxURL="/locations?name=" allowFreeText="true" condition="$('type_of_confirmatory_hiv_test').value != 'NOT DONE'" field_type="alpha" helpText="Location of confirmatory HIV test" id="confirmatory_hiv_test_location" name="observations[][value_coded_or_text]"></select>

                    <input condition="$('type_of_confirmatory_hiv_test').value != 'NOT DONE'" field_type="number" helpText="Confirmatory HIV test year" id="confirmatory_hiv_test_year" name="year_confirmatory_hiv_test" tt_onLoad="changeNextButtonForConfirmatoryYear(); changeAbsoluteMinForConfirmatoryYear(); __$('Unknown').style.display = 'inline'; submitParametersOnUnknownConfirmatoryDate();setAbsoluteMaxYear();" tt_pageStyleClass="Numeric NumbersOnly" type="text" />

                    <select condition="$('type_of_confirmatory_hiv_test').value != 'NOT DONE' && $('confirmatory_hiv_test_year').value.toLowerCase() != 'unknown'" helpText="Confirmatory HIV test month" id="confirmatory_hiv_test_month" name="month_confirmatory_hiv_test" tt_onLoad="__$('keyboard').style.display = 'none'; validateConfirmatoryMonth();" validationMessage="Please enter a valid date">
                        <option value=""></option>
                        <option value="1">Jan</option>
                        <option value="2">Feb</option>
                        <option value="3">Mar</option>
                        <option value="4">Apr</option>
                        <option value="5">May</option>
                        <option value="6">Jun</option>
                        <option value="7">Jul</option>
                        <option value="8">Aug</option>
                        <option value="9">Sep</option>
                        <option value="10">Oct</option>
                        <option value="11">Nov</option>
                        <option value="12">Dec</option>
                        <!--<option value="Unknown">Unknown</option>-->
                    </select>

                    <input condition="$('type_of_confirmatory_hiv_test').value != 'NOT DONE' && ($('confirmatory_hiv_test_year').value !='Unknown') && ($('confirmatory_hiv_test_month').value != 'Unknown');" field_type="number" helpText="Confirmatory HIV test day" id="confirmatory_hiv_test_day" name="day_confirmatory_hiv_test" tt_onLoad="getDayOfMonthPicker($('confirmatory_hiv_test_year').value, $('confirmatory_hiv_test_month').value);$('nextButton').style.display = 'block'; validateConfirmatoryDay(); setNextButtonToGetConfirmatoryTestDate('confirmatory_hiv_test_date'); changeSubmitFunction();" tt_onUnLoad="updateConfirmDate();" type="text" validationCode="checkConfirmDate()" validationMessage="Confirmatory Test Date out of range  and 2018-09-18" />

                    <input allowFreeText="false" id="confirmatory_hiv_test_date" name="observations[][value_datetime]" type="hidden" value="" value_datetime="true" />

                    <input name="commit" type="submit" value="Finish" />

                </form>

                <div id="confirmatory-test-popup-div">
                    <div id="confirmatory-test-popup-header">
                        <center>Reminder </center>
                    </div><br />
                    <div>

                        <span style="font-size: 16pt;">
                            <center>
                                <i><b id="confirmatory-test-header">UKNOWN HIV CONFIRMATORY TEST</b></i><br />
                                Arrange for a confirmatory test
                            </center>
                        </span>
                        <div style="padding-top: 65px;">
                            <span id="confirmatory-test-yes" onclick="hideConfirmatoryTestPopup();" class="confirmatory-test-my_button" style="position: relative;">Ok</span>
                        </div>
                    </div>
                </div>

                <div id="confirmatory-test-cover"></div>

                <div id="popup-div">
                    <div id="popup-header">
                        <center>CONTRADICTING STAGE DEFINING CONDITIONS</center>
                    </div><br />
                    <div>

                        <div style="padding-top: 65px;">
                            <span id="yes" onclick="continueProcess();" class="my_button" style="position: relative;">Keep 'Asymptomatic'</span>
                            <span id="no" onclick="hidePopup();" class="my_button" style=" position: relative; right: 20px;">Keep other conditions</span>
                        </div>
                    </div>
                </div>
                <div id="cover"></div>

                <style type="text/css">

                    .my_button {
                        -moz-user-select: none;
                        background-image: none;
                        border: 1px solid transparent;
                        border-radius: 4px;
                        cursor: pointer;
                        display: inline-block;
                        font-size: 16px;
                        font-weight: bolder;
                        line-height: 2.29;
                        margin-bottom: 0;
                        padding: 6px 56px;
                        text-align: center;
                        vertical-align: middle;
                        white-space: nowrap;
                        background-color: #337ab7;
                        border-color: #2e6da4;
                        color: #fff;
                        float: right;
                        margin-top: -5px;
                    }


                    #popup-div {
                        display: none;
                        background-color: #F4F4F4;
                        border: 2px solid #E0E0E0;
                        border-radius: 15px;
                        height: 185px;
                        padding: 5px;
                        position: absolute;
                        margin-top: 100px;
                        width: 630px;
                        /*margin-left: 430px;*/
                        left: 40%;
                        z-index: 991;
                    }

                    #popup-header{
                        border-bottom: 2px solid #7D9EC0;
                        margin-left: -5px;
                        width: 101.5%;
                        background-color: #FFFFFF;
                        margin-top: -5px;
                        padding-top: 5px;
                        border-radius: 15px 15px 0 0;
                        font-size: 14pt;
                        font-weight: bolder;
                    }

                    #cover{
                        display: none;
                        position: absolute;
                        background-color: black;
                        width: 100%;
                        height: 102%;
                        left: 0%;
                        top: 0%;
                        z-index: 990;
                        opacity: 0.65;
                    }

                    #yes, #no {
                        -webkit-box-sizing: border-box;
                        -moz-box-sizing: border-box;
                        box-sizing: border-box;
                        bottom: 0px;
                    }

                    #yes {
                        margin-right: 13px;
                    }

                </style>

                <style type="text/css">

                    .confirmatory-test-my_button {
                        -moz-user-select: none;
                        background-image: none;
                        border: 1px solid transparent;
                        border-radius: 4px;
                        cursor: pointer;
                        display: inline-block;
                        font-size: 16px;
                        font-weight: bolder;
                        line-height: 2.29;
                        margin-bottom: 0;
                        padding: 6px 56px;
                        text-align: center;
                        vertical-align: middle;
                        white-space: nowrap;
                        background-color: #337ab7;
                        border-color: #2e6da4;
                        color: #fff;
                        float: right;
                        margin-top: -5px;
                    }


                    #confirmatory-test-popup-div {
                        display: none;
                        background-color: #F4F4F4;
                        border: 2px solid #E0E0E0;
                        border-radius: 15px;
                        height: 240px;
                        padding: 5px;
                        position: absolute;
                        top: 40%;
                        /*margin-top: 100px;*/
                        width: 560px;
                        /*margin-left: 430px;*/
                        left: 40%;
                        z-index: 991;
                    }

                    #confirmatory-test-popup-header{
                        border-bottom: 2px solid #7D9EC0;
                        margin-left: -5px;
                        width: 101.5%;
                        background-color: #FFFFFF;
                        margin-top: -5px;
                        padding-top: 5px;
                        border-radius: 15px 15px 0 0;
                        font-size: 14pt;
                        font-weight: bolder;
                    }

                    #confirmatory-test-cover{
                        display: none;
                        position: absolute;
                        background-color: black;
                        width: 100%;
                        height: 102%;
                        left: 0%;
                        top: 0%;
                        z-index: 990;
                        opacity: 0.65;
                    }

                    #confirmatory-test-yes{
                        -webkit-box-sizing: border-box;
                        -moz-box-sizing: border-box;
                        box-sizing: border-box;
                        bottom: 0px;
                    }
                </style>
                <script type="text/javascript">
                    function hideConfirmatoryTestPopup() {
                        document.getElementById("confirmatory-test-popup-div").style.display = 'none';
                        document.getElementById("confirmatory-test-cover").style.display = 'none';
                    }

                    function showConfirmatoryTestPopup() {
                        document.getElementById("confirmatory-test-popup-div").style.display = 'inline';
                        document.getElementById("confirmatory-test-cover").style.display = 'inline';

                        jQuery('#confirmatory-test-popup-div').center();
                    }

                    function setUnknownConfirmatoryTestForPopup() {
                        unknown_confirmatory_option_input = jQuery("li[tstvalue='NOT DONE']")[0];
                        if (unknown_confirmatory_option_input) {
                            unknown_confirmatory_option_input.onmouseup = function () {
                                if (!unknown_confirmatory_option_input.style.backgroundColor.match(/lightBlue/i)) {
                                    showConfirmatoryTestPopup();
                                }
                            }
                        }
                    }

                    function setSelectedStageConditions(stage) {
                        selected_stage_conditions[stage] = $("touchscreenInput" + tstCurrentPage).value;
                        selected_stage_conditions_copy[stage] = $("touchscreenInput" + tstCurrentPage).value;
                    }

                    function resetStageDefiningConditions() {
                        selected_stage_conditions = JSON.parse(JSON.stringify(selected_stage_conditions_copy))
                        stage_defining_conditions = __$('touchscreenInput' + tstCurrentPage).value;

                        if (stage_defining_conditions.length > 0) {
                            if (stage_defining_conditions.match(/Asymptomatic HIV infection/i)) {
                                if (selected_stage_conditions[4])
                                    delete selected_stage_conditions[4]; //Delete Stage 4 conditions
                                if (selected_stage_conditions[3])
                                    delete selected_stage_conditions[3]; //Delete Stage 3 conditions
                                if (selected_stage_conditions[2])
                                    delete selected_stage_conditions[2]; //Delete Stage 2 conditions
                            }
                        }
                    }

                    function showContraindicatingConditionsConfirmationPopup() {
                        document.getElementById("popup-div").style.display = 'inline';
                        document.getElementById("cover").style.display = 'inline';
                    }

                    function setOptionsForContraindicationsPopup() {
                        if (age >= 15) {
                            stageFourConditions = __$('stage_4_conditions').value;
                            stageThreeConditions = __$('stage_3_conditions').value;
                            stageTwoConditions = __$('stage_2_conditions').value;
                        } else {
                            stageFourConditions = jQuery('.stage_4_conditions')[0].value;
                            stageThreeConditions = jQuery('.stage_3_conditions')[0].value;
                            stageTwoConditions = jQuery('.stage_2_conditions')[0].value;
                        }

                        asymptomatic_option_input = jQuery("li[tstvalue='Asymptomatic HIV infection']")[0];

                        if (stageFourConditions.length > 0 || stageThreeConditions.length > 0 || stageTwoConditions.length > 0) {
                            asymptomatic_option_input.onmouseup = function () {
                                showContraindicatingConditionsConfirmationPopup();
                            }
                        }
                    }

                    function showContraindicatingConditionsConfirmationPopup() {
                        stageFourConditions = __$('stage_4_conditions').value;
                        stageThreeConditions = __$('stage_3_conditions').value;
                        stageTwoConditions = __$('stage_2_conditions').value;

                        asymptomatic_option_input = jQuery("li[tstvalue='Asymptomatic HIV infection']")[0];
                        if (stageFourConditions.length > 0 || stageThreeConditions.length > 0 || stageTwoConditions.length > 0) {
                            if (!asymptomatic_option_input.style.backgroundColor.match(/lightBlue/i)) {
                                document.getElementById("popup-div").style.display = 'inline';
                                document.getElementById("cover").style.display = 'inline';
                            }
                        }

                    }

                    function hidePopup() {
                        clearInput();
                        document.getElementById("popup-div").style.display = 'none';
                        document.getElementById("cover").style.display = 'none';
                    }

                    function continueProcess() {
                        $('stage_4_conditions').value = '';
                        $('stage_3_conditions').value = '';
                        $('stage_2_conditions').value = '';
                        jQuery("#popup-div").hide();
                        jQuery("#cover").hide();
                        forceStageOneAvailabe();
                    }

                    function changeNextButtonForConfirmatoryYear() {

                    }

                    function changeAbsoluteMinForConfirmatoryYear() {
                        year_started_art = jQuery('#year_started_art')[0].value;
                        if (parseInt(year_started_art)) {
                            jQuery('#touchscreenInput' + tstCurrentPage).attr("absoluteMin", year_started_art);
                            jQuery('#touchscreenInput' + tstCurrentPage).attr("min", year_started_art);
                        } else {
                            jQuery('#touchscreenInput' + tstCurrentPage).attr("absoluteMin", '1840');
                            jQuery('#touchscreenInput' + tstCurrentPage).attr("min", '1940');
                        }
                    }

                    function validateConfirmatoryMonth() {
                        confirmatoryYear = parseInt(jQuery('#confirmatory_hiv_test_year')[0].value);
                        date = sessionDate;
                        currYear = date.getFullYear();
                        currDay = date.getDate();
                        availableMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                        year_started_art = parseInt(jQuery('#year_started_art')[0].value);
                        month_started_art = parseInt(jQuery('#month_started_art')[0].value);

                        if (confirmatoryYear == currYear) {
                            currentMonth = [];
                            numOfloops = (date.getMonth() + 1);

                            for (var i = 0; i < numOfloops; i++) {
                                currentMonth.push(availableMonths[i]);
                            }
                            rule = currentMonth.join("|");
                            rule = rule + "|Unknown";
                            return $('touchscreenInput' + tstCurrentPage).setAttribute('validationRule', rule);
                        }

                        if (confirmatoryYear != currYear) {
                            rule = availableMonths.join("|");
                            rule = rule + "|Unknown";
                            return $('touchscreenInput' + tstCurrentPage).setAttribute('validationRule', rule);
                        }

                    }

                    /*function validateMonthStartedART(){
                     date = new Date;
                     currYear = date.getFullYear();
                     currDay = date.getDate();
                     availableMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                     
                     year_started_art = parseInt(jQuery('#year_started_art')[0].value);
                     if (year_started_art == currYear){
                     currentMonth = [];
                     numOfloops = ((new Date).getMonth() + 1);
                     
                     for(var i = 0; i < numOfloops; i++){
                     currentMonth.push(availableMonths[i]);
                     }
                     
                     rule = currentMonth.join("|");
                     rule = rule + "|Unknown";
                     return $('touchscreenInput'+tstCurrentPage).setAttribute('validationRule',rule);
                     }
                     
                     }*/

                    function validateMonthStartedART() {
                        year_art_last_taken = parseInt(jQuery('#year_art_last_taken')[0].value);
                        month_art_last_taken = parseInt(jQuery('#month_art_last_taken')[0].value);
                        date = sessionDate;
                        currYear = date.getFullYear();
                        currDay = date.getDate();
                        availableMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                        year_started_art = parseInt(jQuery('#year_started_art')[0].value);

                        if (year_started_art < year_art_last_taken) {
                            rule = availableMonths.join("|");
                            rule = rule + "|Unknown";
                            return $('touchscreenInput' + tstCurrentPage).setAttribute('validationRule', rule);
                        } else {
                            if (year_started_art == currYear) {
                                currentMonth = [];
                                numOfloops = (sessionDate.getMonth() + 1);

                                for (var i = 0; i < numOfloops; i++) {
                                    currentMonth.push(availableMonths[i]);
                                }
                                rule = currentMonth.join("|");
                                rule = rule + "|Unknown";
                                return $('touchscreenInput' + tstCurrentPage).setAttribute('validationRule', rule);
                            } else {
                                rule = availableMonths.join("|");
                                rule = rule + "|Unknown";
                                return $('touchscreenInput' + tstCurrentPage).setAttribute('validationRule', rule);
                            }
                        }

                    }

                    function setAbsoluteMaxYearStartedART() {
                        year_taken_art = parseInt(jQuery('#year_art_last_taken')[0].value);
                        date = sessionDate;
                        currYear = date.getFullYear();

                        if (parseInt(year_taken_art)) {
                            jQuery('#touchscreenInput' + tstCurrentPage).attr("absoluteMax", year_taken_art);
                        } else {
                            jQuery('#touchscreenInput' + tstCurrentPage).attr("absoluteMax", currYear);
                        }
                    }

                    function validateMonthARTTaken() {
                        date = sessionDate;
                        currYear = sessionDate.getFullYear();
                        currDay = date.getDate();
                        availableMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                        year_taken_art = parseInt(jQuery('#year_art_last_taken')[0].value);
                        if (year_taken_art == currYear) {
                            currentMonth = [];
                            numOfloops = (sessionDate.getMonth() + 1);

                            for (var i = 0; i < numOfloops; i++) {
                                currentMonth.push(availableMonths[i]);
                            }

                            rule = currentMonth.join("|");
                            rule = rule + "|Unknown";
                            return $('touchscreenInput' + tstCurrentPage).setAttribute('validationRule', rule);
                        }
                        if (year_taken_art == birthYear) {
                            currentMonth = [];

                            for (var i = birthMonth - 1; i < availableMonths.length; i++) {
                                currentMonth.push(availableMonths[i]);
                            }

                            rule = currentMonth.join("|");
                            rule = rule + "|Unknown";
                            return $('touchscreenInput' + tstCurrentPage).setAttribute('validationRule', rule);
                        }
                    }

                    function validateDayARTTaken() {
                        date = sessionDate;
                        currYear = date.getFullYear();
                        currDay = date.getDate();
                        currMonth = date.getMonth() + 1;
                        availableMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                        year_taken_art = parseInt(jQuery('#year_art_last_taken')[0].value);
                        month_taken_art = parseInt(jQuery('#month_art_last_taken')[0].value);

                        if (year_taken_art == currYear) {
                            if (month_taken_art == currMonth) {
                                return $('touchscreenInput' + tstCurrentPage).setAttribute('absoluteMax', currDay);
                            }
                        }

                        if (year_taken_art == birthYear) {
                            if (month_taken_art == birthMonth) {
                                return $('touchscreenInput' + tstCurrentPage).setAttribute('absoluteMin', birthDay);
                            }
                        }
                    }

                    function validateDayStartedART() {
                        date = sessionDate;
                        currYear = date.getFullYear();
                        currDay = date.getDate();
                        currMonth = date.getMonth() + 1;
                        availableMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                        year_started_art = parseInt(jQuery('#year_started_art')[0].value);
                        month_started_art = parseInt(jQuery('#month_started_art')[0].value);

                        year_taken_art = parseInt(jQuery('#year_art_last_taken')[0].value);
                        month_taken_art = parseInt(jQuery('#month_art_last_taken')[0].value);
                        day_taken_art = parseInt(jQuery('#day_art_last_taken')[0].value);

                        if ((year_taken_art != currYear) && (year_started_art == year_taken_art)) {
                            if (month_taken_art == month_started_art) {
                                return $('touchscreenInput' + tstCurrentPage).setAttribute('absoluteMax', day_taken_art);
                            }
                        }

                        if (year_started_art == currYear) {
                            if (month_started_art == currMonth) {
                                return $('touchscreenInput' + tstCurrentPage).setAttribute('absoluteMax', currDay);
                            }
                        }
                    }

                    function validateConfirmatoryDay() {
                        date = sessionDate;
                        currYear = date.getFullYear();
                        currDay = date.getDate();
                        currMonth = date.getMonth() + 1;

                        confirmatoryMonth = parseInt(jQuery('#confirmatory_hiv_test_month')[0].value);
                        confirmatoryYear = parseInt(jQuery('#confirmatory_hiv_test_year')[0].value);

                        year_started_art = parseInt(jQuery('#year_started_art')[0].value);
                        month_started_art = parseInt(jQuery('#month_started_art')[0].value);
                        day_started_art = parseInt(jQuery('#day_started_art')[0].value);

                        if (confirmatoryYear == currYear) {
                            if (confirmatoryMonth == currMonth) {
                                return $('touchscreenInput' + tstCurrentPage).setAttribute('absoluteMax', currDay);
                            }
                        }

                    }

                    function setAbsoluteMaxCD4Year() {
                        year_started_art = parseInt(jQuery('#year_started_art')[0].value);
                        date = sessionDate;
                        currYear = date.getFullYear();

                        if (parseInt(year_started_art)) {
                            jQuery('#touchscreenInput' + tstCurrentPage).attr("absoluteMax", year_started_art);
                        } else {
                            jQuery('#touchscreenInput' + tstCurrentPage).attr("absoluteMax", currYear);
                        }
                    }

                    function validateCD4Month() {
                        date = sessionDate;
                        currYear = date.getFullYear();
                        currDay = date.getDate();
                        availableMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                        year_of_cd4 = parseInt(jQuery('#year_of_cd4')[0].value);
                        year_started_art = parseInt(jQuery('#year_started_art')[0].value);
                        month_started_art = parseInt(jQuery('#month_started_art')[0].value);

                        if (year_of_cd4 < year_started_art) {
                            rule = availableMonths.join("|");
                            rule = rule + "|Unknown";
                            return $('touchscreenInput' + tstCurrentPage).setAttribute('validationRule', rule);
                        }
                        else {
                            if (year_of_cd4 == year_started_art) {
                                if (year_of_cd4 < currYear) {
                                    rule = availableMonths.join("|");
                                    rule = rule + "|Unknown";
                                    return $('touchscreenInput' + tstCurrentPage).setAttribute('validationRule', rule);
                                } else {
                                    currentMonth = [];
                                    numOfloops = (date.getMonth() + 1);

                                    for (var i = 0; i < numOfloops; i++) {
                                        currentMonth.push(availableMonths[i]);
                                    }
                                    rule = currentMonth.join("|");
                                    rule = rule + "|Unknown";
                                    return $('touchscreenInput' + tstCurrentPage).setAttribute('validationRule', rule);
                                }
                            } else {
                                rule = availableMonths.join("|");
                                rule = rule + "|Unknown";
                                return $('touchscreenInput' + tstCurrentPage).setAttribute('validationRule', rule);
                            }
                        }

                    }

                    function validateCD4Day() {
                        date = sessionDate;
                        currYear = date.getFullYear();
                        currDay = date.getDate();
                        currMonth = date.getMonth() + 1;

                        cd4Month = parseInt(jQuery('#month_of_cd4')[0].value);
                        cd4Year = parseInt(jQuery('#year_of_cd4')[0].value);

                        year_started_art = parseInt(jQuery('#year_started_art')[0].value);
                        month_started_art = parseInt(jQuery('#month_started_art')[0].value);
                        day_started_art = parseInt(jQuery('#day_started_art')[0].value);

                        if (cd4Year == currYear) {
                            if (cd4Month == currMonth) {
                                return $('touchscreenInput' + tstCurrentPage).setAttribute('absoluteMax', currDay);
                            }
                        }

                        if ((year_of_cd4 == year_started_art) && (year_of_cd4 != currYear)) {
                            if (cd4Month == month_started_art) {
                                return $('touchscreenInput' + tstCurrentPage).setAttribute('absoluteMax', day_started_art);
                            }
                        }

                    }

                    function preselectSevereWeightLoss() {
                        if (parseFloat(currentBmi) < 16) {
                            console.log("It's a bit funny now")
                            severe_weight_loss_text = 'Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained';
                            severe_weight_loss_option_input = jQuery("li[tstvalue='Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained']")[0];
                            severe_weight_loss_option_id = severe_weight_loss_option_input.id;
                            weight_loss_input = document.getElementById('optionValue' + severe_weight_loss_option_id);
                            current_input_values = $('touchscreenInput' + tstCurrentPage).value.split(';');
                            if (current_input_values.indexOf(severe_weight_loss_text) == -1) {
                                updateTouchscreenInputForSelect(weight_loss_input); //Run this only when the option is not selected;
                            }

                        }
                    }

                    function preselectSevereWeightLossPaeds() {
                        currentWeight = parseFloat($("weight").value);
                        current_weight_percentile = (currentWeight / (median_weight_height[0]) * 100)
                        severe_weight_loss_text = "Severe unexplained wasting or malnutrition not responding to treatment (weight-for-height/ -age <70% or MUAC less than 11cm or oedema)"
                        if (current_weight_percentile < 70) {
                            console.log("It's a bit funny now")
                            severe_weight_loss_option_input = jQuery("li[tstvalue='Severe unexplained wasting or malnutrition not responding to treatment (weight-for-height/ -age <70% or MUAC less than 11cm or oedema)']")[0];
                            severe_weight_loss_option_id = severe_weight_loss_option_input.id;
                            weight_loss_input = document.getElementById('optionValue' + severe_weight_loss_option_id);
                            current_input_values = $('touchscreenInput' + tstCurrentPage).value.split(';');
                            if (current_input_values.indexOf(severe_weight_loss_text) == -1) {
                                updateTouchscreenInputForSelect(weight_loss_input); //Run this only when the option is not selected;
                            }
                        }
                    }

                    function preselectModerateWeightLoss() {
                        if (parseFloat(currentBmi) >= 16.0 && parseFloat(currentBmi) <= 18.5) {
                            moderate_weight_loss_option_input = jQuery("[tstvalue='Moderate weight loss less than or equal to 10 percent, unexplained']")[0];
                            moderate_weight_loss_option_id = moderate_weight_loss_option_input.id;
                            weight_loss_input = document.getElementById('optionValue' + moderate_weight_loss_option_id);
                            moderate_weight_loss_text = 'Moderate weight loss less than or equal to 10 percent, unexplained'

                            severe_weight_loss_text = "Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained";
                            current_input_values = $('touchscreenInput' + tstCurrentPage).value.split(';');
                            if (selected_stage_conditions[3]) {
                                selected_stage_three_conditions = selected_stage_conditions[3].split(';');
                                if (selected_stage_three_conditions.indexOf(severe_weight_loss) == -1) {
                                    if (current_input_values.indexOf(moderate_weight_loss_text) == -1) {
                                        updateTouchscreenInputForSelect(weight_loss_input); //Preselect moderate if severe weight loss not selected
                                    }
                                }
                            }
                        }

                        disableModerateWeightLossOption();
                    }

                    function preselectModerateWeightLossPaeds() {
                        currentWeight = parseFloat($("weight").value);
                        current_weight_percentile = (currentWeight / (median_weight_height[0]) * 100)

                        if (current_weight_percentile >= 70 && current_weight_percentile <= 79) {
                            moderate_weight_loss_option_input = jQuery("[tstvalue='Moderate unexplained wasting/malnutrition not responding to treatment (weight-for-height/ -age 70-79% or muac 11-12 cm)'")[0];
                            moderate_weight_loss_option_id = moderate_weight_loss_option_input.id;
                            weight_loss_input = document.getElementById('optionValue' + moderate_weight_loss_option_id);
                            moderate_weight_loss_text = 'Moderate unexplained wasting/malnutrition not responding to treatment (weight-for-height/ -age 70-79% or muac 11-12 cm'
                            severe_weight_loss_text = "Severe unexplained wasting or malnutrition not responding to treatment (weight-for-height/ -age <70% or MUAC less than 11cm or oedema)";
                            current_input_values = $('touchscreenInput' + tstCurrentPage).value.split(';');
                            if (selected_stage_conditions[4]) {
                                selected_stage_four_conditions = selected_stage_conditions[4].split(';');
                                if (selected_stage_four_conditions.indexOf(severe_weight_loss) == -1) {
                                    if (current_input_values.indexOf(moderate_weight_loss_text) == -1) {
                                        updateTouchscreenInputForSelect(weight_loss_input); //Preselect moderate if severe weight loss not selected
                                    }
                                }
                            }
                        }

                        disableModerateWeightLossOptionPaeds();
                    }

                    function disableModerateWeightLossOption() {
                        moderate_weight_loss_option_input = jQuery("[tstvalue='Moderate weight loss less than or equal to 10 percent, unexplained']")[0];
                        moderate_weight_loss_option_id = moderate_weight_loss_option_input.id;

                        weight_loss_input = document.getElementById('optionValue' + moderate_weight_loss_option_id);
                        severe_weight_loss = "Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained";

                        if (selected_stage_conditions[3]) {
                            selected_stage_three_conditions = selected_stage_conditions[3].split(';');
                            if (selected_stage_three_conditions.indexOf(severe_weight_loss) != -1) {
                                //weight_loss_input.style.backgroundColor = '#CDBA96';
                                //moderate_wight_loss_option_input.style.backgroundColor = '#CDBA96';
                                moderate_weight_loss_text = weight_loss_input.innerHTML;
                                weight_loss_input.innerHTML = "<span class='disabled_check'>" + moderate_weight_loss_text + " ( Severe weight loss already selected )</span>"
                                moderate_weight_loss_option_input.onclick = null;
                                moderate_weight_loss_option_input.onmousedown = null;
                                moderate_weight_loss_option_input.onmouseup = null;

                                img_input = moderate_weight_loss_option_input.getElementsByTagName("img")[0];
                                img_input.src = '';
                                img_input.alt = '';


                                if (weight_loss_input.getAttribute('style').match(/lightblue/i)) {
                                    updateTouchscreenInputForSelect(__$('optionValue' + "0"), weight_loss_input);
                                    displayCountOfSelectedConditions();
                                } else {
                                    displayCountOfSelectedConditions();
                                }

                            } else {
                                disableModerateWeightLossOptionForNormalBMI();
                            }

                        }

                    }

                    function disableModerateWeightLossOptionPaeds() {
                        moderate_wight_loss_option_input = jQuery("[tstvalue='Moderate unexplained wasting/malnutrition not responding to treatment (weight-for-height/ -age 70-79% or muac 11-12 cm)']")[0];
                        moderate_wight_loss_option_id = moderate_wight_loss_option_input.id;

                        weight_loss_input = document.getElementById('optionValue' + moderate_wight_loss_option_id);
                        severe_weight_loss = "Severe unexplained wasting or malnutrition not responding to treatment (weight-for-height/ -age <70% or MUAC less than 11cm or oedema)";

                        if (selected_stage_conditions[4]) {
                            selected_stage_four_conditions = selected_stage_conditions[4].split(';');
                            if (selected_stage_four_conditions.indexOf(severe_weight_loss) != -1) {
                                moderate_weight_loss_text = weight_loss_input.innerHTML;
                                weight_loss_input.innerHTML = "<span class='disabled_check'>" + moderate_weight_loss_text + " ( Severe weight loss already selected )</span>"
                                moderate_wight_loss_option_input.onclick = null;
                                moderate_wight_loss_option_input.onmousedown = null;
                                moderate_wight_loss_option_input.onmouseup = null;

                                img_input = moderate_wight_loss_option_input.getElementsByTagName("img")[0];
                                img_input.src = '';
                                img_input.alt = '';


                                if (weight_loss_input.getAttribute('style').match(/lightblue/i)) {
                                    updateTouchscreenInputForSelect(__$('optionValue' + "0"), weight_loss_input);
                                    displayCountOfSelectedConditions();
                                } else {
                                    displayCountOfSelectedConditions();
                                }

                            } else {
                                disableModerateWeightLossOptionForNormalBMI();
                            }
                        }

                    }

                    function disableSevereWeightLossInputForNormalBMI() {
                        severe_weight_loss_option_input = jQuery("[tstvalue='Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained']")[0];
                        severe_weight_loss_option_id = severe_weight_loss_option_input.id;


                        weight_loss_input = document.getElementById('optionValue' + severe_weight_loss_option_id);
                        severe_weight_loss = "Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained";

                        if (parseFloat(currentBmi) > 18.5) {
                            //weight_loss_input.style.backgroundColor = '#CDBA96';
                            //severe_weight_loss_option_input.style.backgroundColor = '#CDBA96';
                            //moderate_weight_loss_text = weight_loss_input.innerHTML;
                            //weight_loss_input.innerHTML = moderate_weight_loss_text + " <i>( BMI is " + currentBmi + "  )</i>"
                            //severe_weight_loss_option_input.onclick = null;
                            //severe_weight_loss_option_input.onmousedown = null;
                            //severe_weight_loss_option_input.onmouseup = null;

                            //img_input = severe_weight_loss_option_input.getElementsByTagName("img")[0];
                            //img_input.src = '';
                            //img_input.alt = '';
                            document.getElementById('currentBMI').innerHTML = currentBmi;
                            weight_loss_input.setAttribute('onmousedown', 'alertOnNormalBMI()');
                        }
                    }

                    function disableModerateWeightLossOptionForNormalBMI() {
                        moderate_weight_loss_option_input = jQuery("[tstvalue='Moderate weight loss less than or equal to 10 percent, unexplained']")[0];
                        moderate_wight_loss_option_id = moderate_weight_loss_option_input.id;

                        weight_loss_input = document.getElementById('optionValue' + moderate_weight_loss_option_input.id);

                        if (parseFloat(currentBmi) > 18.5) {
                            //moderate_weight_loss_option_input.style.backgroundColor = '#CDBA96';
                            moderate_weight_loss_text = weight_loss_input.innerHTML;
                            //weight_loss_input.innerHTML = moderate_weight_loss_text + " <i>( BMI is " + currentBmi + "  )</i>";
                            //moderate_weight_loss_option_input.onclick = null;
                            //moderate_weight_loss_option_input.onmousedown = null;
                            //moderate_weight_loss_option_input.onmouseup = null;

                            img_input = moderate_weight_loss_option_input.getElementsByTagName("img")[0];
                            //img_input.src = '';
                            //img_input.alt = '';
                        }

                    }

                    function hideTextInput() {
                        jQuery('#touchscreenInput' + tstCurrentPage).hide();
                    }

                    function displayCountOfSelectedConditions() {
                        jQuery('#helpText' + tstCurrentPage + ' > #count-selected').remove();
                        jQuery('#helpText' + tstCurrentPage).append("<span id='count-selected'>&nbsp;</span>")

                        if ($("touchscreenInput" + tstCurrentPage).value.length > 0) {
                            selectedValuesCount = $("touchscreenInput" + tstCurrentPage).value.split(";").length;
                        } else {
                            selectedValuesCount = 0;
                        }

                        jQuery('#helpText' + tstCurrentPage + ' > #count-selected').html('&nbsp;(' + selectedValuesCount + ' selected)');
                        liOptions = document.getElementsByTagName("li");
                        for (var i = 0; i <= liOptions.length - 1; i++) {
                            addEvent(liOptions[i], "click", function () {
                                if ($("touchscreenInput" + tstCurrentPage).value.length > 0) {
                                    selectedValuesCount = $("touchscreenInput" + tstCurrentPage).value.split(";").length;
                                } else {
                                    selectedValuesCount = 0
                                }
                                jQuery('#helpText' + tstCurrentPage + ' > #count-selected').html('&nbsp;(' + selectedValuesCount + ' selected)');

                            });

                        }
                    }

                    function addEvent(obj, evType, fn) {
                        if (obj.addEventListener) {
                            obj.addEventListener(evType, fn, false);
                            return true;
                        } else if (obj.attachEvent) {
                            var r = obj.attachEvent("on" + evType, fn);
                            return r;
                        } else {
                            alert("Handler could not be attached");
                        }
                    }


                    function alertOnNormalBMI() {
                        try {
                            severe_weight_loss_option_id = severe_weight_loss_option_input.id;
                        } catch (e) {
                            severe_weight_loss_option_input = jQuery("[tstvalue='Moderate weight loss less than or equal to 10 percent, unexplained']")[0];
                            severe_weight_loss_option_id = severe_weight_loss_option_input.id;
                        }

                        weight_loss_input = document.getElementById('optionValue' + severe_weight_loss_option_id);

                        if (weight_loss_input.getAttribute('style').match(/lightblue/i)) {
                            //selectCondition();
                            displayCountOfSelectedConditions();
                            return;
                        }

                        document.getElementById("regimen-change-popup-div").style.display = 'inline';
                        document.getElementById("regimen-change-cover").style.display = 'inline';
                    }

                    function closeAlertOnNormalBMI() {
                        document.getElementById("regimen-change-popup-div").style.display = 'none';
                        document.getElementById("regimen-change-cover").style.display = 'none';
                    }

                    function selectCondition() {
                        severe_weight_loss_option_input = jQuery("[tstvalue='Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained']")[0];

                        try {
                            severe_weight_loss_option_id = severe_weight_loss_option_input.id;
                        } catch (e) {
                            severe_weight_loss_option_input = jQuery("[tstvalue='Moderate weight loss less than or equal to 10 percent, unexplained']")[0];
                            severe_weight_loss_option_id = severe_weight_loss_option_input.id;
                        }

                        weight_loss_input = document.getElementById('optionValue' + severe_weight_loss_option_id);
                        updateTouchscreenInputForSelect(__$('optionValue' + "0"), weight_loss_input);
                        displayCountOfSelectedConditions();
                        closeAlertOnNormalBMI();
                    }

                    jQuery.fn.center = function () {
                        parent = this.parent();
                        this.css({
                            "position": "absolute",
                            "top": (((jQuery(parent).height() - this.outerHeight()) / 2) + jQuery(parent).scrollTop() - 100 + "px"),
                            "left": (((jQuery(parent).width() - this.outerWidth()) / 2) + jQuery(parent).scrollLeft() + "px")
                        });
                        return this;
                    }
                </script>
                <!--
                <script language="javascript" type="text/javascript" src="/javascripts/show_category_hack.js" defer="true"></script>
                -->
                <style>
                    #regimen-change-popup-div {
                        display: none;
                        background-color: #F4F4F4;
                        border: 2px solid #E0E0E0;
                        border-radius: 15px;
                        height: 270px;
                        padding: 5px;
                        position: absolute;
                        margin-top: 100px;
                        width: 600px;
                        margin-left: 430px;
                        z-index: 991;
                    }

                    #regimen-change-cover{
                        display: none;
                        position: absolute;
                        background-color: black;
                        width: 100%;
                        height: 102%;
                        left: 0%;
                        top: 0%;
                        z-index: 990;
                        opacity: 0.65;
                    }

                    #btnContainer {
                        width: 99.9%;
                    }
                    .btns {
                        -moz-user-select: none;
                        background-image: none;
                        border: 1px solid transparent;
                        border-radius: 4px;
                        cursor: pointer;
                        display: inline-block;
                        font-size: 16px;
                        font-weight: bolder;
                        line-height: 2.29;
                        margin-bottom: 0;
                        padding: 6px 56px;
                        text-align: center;
                        vertical-align: middle;
                        white-space: nowrap;
                        background-color: #337ab7;
                        border-color: #2e6da4;
                        color: #fff;
                        float: right;
                        margin-top: -5px;
                    }

                    #yesBtn{
                        -webkit-box-sizing: border-box;
                        -moz-box-sizing: border-box;
                        box-sizing: border-box;
                        bottom: 0px;
                    }

                    #noBtn{
                        -webkit-box-sizing: border-box;
                        -moz-box-sizing: border-box;
                        box-sizing: border-box;
                        bottom: 0px;
                        margin-right: 27px;
                    }

                    .disabled_check {
                        padding-left: 52px;
                    }

                </style>

                <div id="regimen-change-cover"></div>
                <div id="regimen-change-popup-div">

                    <table style="width: 99.9%; margin-bottom: 95px;">
                        <tr>
                            <td style="text-align: center; font-weight: bold; color: green;
                                border-style: solid; border-width: 0px 0px 2px 0px;">
                                Notice
                            </td>
                        </tr>
                        <tr>
                            <td style="text-align: center; font-weight: bold; color: black;">
                                Patient has a BMI of:&nbsp;<span id="currentBMI"></span><p>
                                    Are you sure with your selection?</p>
                            </td>
                        </tr>
                    </table>

                    <div id="btnContainer">
                        <input type="button" class="btns" id="yesBtn" onmousedown="selectCondition();" value="Yes, select condition" />
                        <input type="button" class="btns" id="noBtn" onmousedown="closeAlertOnNormalBMI();" value="No" />
                    </div>
                </div>

            </div>
        </div>
    </body>

</html>
